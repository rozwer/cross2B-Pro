# SEO記事自動生成ワークフロー

> **実装計画は `ROADMAP.md` を参照**

---

## 用語対応表

| 日本語               | 英語       | 説明                             |
| -------------------- | ---------- | -------------------------------- |
| 工程（step）         | step       | ワークフローの処理単位           |
| 成果物（artifact）   | artifact   | 各工程の出力ファイル             |
| 承認（approval）     | approval   | 人間による確認・許可             |
| 却下（rejection）    | rejection  | 人間による差し戻し               |
| 再実行（retry）      | retry      | 同一条件での工程再試行           |
| 部分再実行（resume） | resume     | 特定工程からの再開               |
| 検証（validation）   | validation | 出力の妥当性確認                 |
| フォールバック       | fallback   | 代替手段への自動切替（**禁止**） |

---

## 全体フロー

```
【半自動フロー】人間確認あり
工程-1 → 工程0 → 工程1 → 工程2 → 工程3A/3B/3C（並列）
                                    ↓
                              [承認待ち]
                                    ↓
【全自動フロー】一気通貫実行
工程4 → 工程5 → 工程6 → 工程6.5 → 工程7A → 工程7B → 工程8 → 工程9 → 工程10
```

## 工程一覧

| 工程 | 名称                  | AI         | 出力                     | 詳細                          |
| ---- | --------------------- | ---------- | ------------------------ | ----------------------------- |
| -1   | 絶対条件ヒアリング    | 手動/UI    | スプレッドシート相当     |                               |
| 0    | キーワード選定        | Gemini     | `step0_keyword.json`     |                               |
| 1    | 競合記事本文取得      | GAS/Tool   | `step1_competitors.csv`  | @backend/api.md#tools         |
| 2    | CSV読み込み・検証     | Gemini     | （検証のみ）             |                               |
| 3A   | クエリ分析・ペルソナ  | Gemini     | `step3a_query.json`      | 並列                          |
| 3B   | 共起語・関連KW抽出    | Gemini     | `step3b_keywords.json`   | 並列・**心臓部**              |
| 3C   | 競合分析・差別化      | Gemini     | `step3c_competitor.json` | 並列                          |
|      | **[承認待ち]**        |            |                          | @backend/temporal.md#approval |
| 4    | 戦略的アウトライン    | Claude     | `step4_outline.json`     |                               |
| 5    | 一次情報収集          | Gemini+Web | `step5_sources.json`     | @backend/api.md#tools         |
| 6    | アウトライン強化版    | Claude     | `step6_enhanced.json`    |                               |
| 6.5  | 統合パッケージ化      | Claude     | `step6_5_package.md`     | **ファイル集約**              |
| 7A   | 本文生成 初稿         | Claude     | `step7a_draft.md`        |                               |
| 7B   | ブラッシュアップ      | Gemini     | `step7b_polished.md`     |                               |
| 8    | ファクトチェック・FAQ | Gemini+Web | `step8_factcheck.json`   |                               |
| 9    | 最終リライト          | Claude     | `step9_final.md`         |                               |
| 10   | 最終出力              | Claude     | `final_article.*`        |                               |

## AI割り当てパターン

- **Gemini**: 分析、検索、自然な表現
- **Claude**: 構造化、統合、品質制御

詳細は @backend/llm.md を参照。

## 成果物パス規約

```
storage/{tenant_id}/{run_id}/{step}/output.json
```

詳細は @backend/database.md#storage を参照。

## 承認フロー

工程3（3A/3B/3C）完了後、工程4開始前に人間確認を挟む。

- Temporal signal で待機/再開
- approve/reject は監査ログ必須

詳細は @backend/temporal.md#approval を参照。

## 4本柱

| 柱         | 説明                                                   |
| ---------- | ------------------------------------------------------ |
| 神経科学   | 認知負荷3概念以内、脳の3領域への訴求                   |
| 行動経済学 | 6原則（損失回避/社会的証明/権威性/希少性/一貫性/好意） |
| LLMO       | 400-600 tokens/section、セクション独立性               |
| KGI        | CTA配置（Early/Mid/Final）                             |

## 用語集

| 用語           | 説明                              |
| -------------- | --------------------------------- |
| CTA            | Call To Action（問い合わせ誘導）  |
| データアンカー | 一次情報の引用                    |
| LLMO           | Large Language Model Optimization |
| 3フェーズ      | Anxiety → Understanding → Action  |

---

## エラーケース網羅

### 全工程共通

| エラーケース          | 期待挙動                                          |
| --------------------- | ------------------------------------------------- |
| LLM API Rate Limit    | exponential backoff で5分間リトライ → 失敗で停止  |
| LLM API タイムアウト  | 同一条件で最大3回リトライ → 失敗で停止            |
| 認証エラー（401/403） | 即座に失敗（NON_RETRYABLE）                       |
| JSON 構文破損         | 決定的修正（末尾カンマ除去等）を試行 → 失敗で停止 |
| スキーマ違反          | 即座に失敗（VALIDATION_FAIL）                     |
| Storage 書き込み失敗  | リトライ → 失敗で停止                             |

### 工程別エラー

| 工程     | エラーケース             | 期待挙動                                               |
| -------- | ------------------------ | ------------------------------------------------------ |
| 1        | SERP 結果 0件            | 即座に失敗（コンテンツなしで続行不可）                 |
| 1        | SERP API 障害            | リトライ3回 → 失敗で停止                               |
| 3A/3B/3C | 一部工程のみ失敗         | 失敗分のみリトライ（詳細は temporal.md#parallel 参照） |
| 5        | 一次情報 URL 全て 404    | 失敗（警告のみで続行は**禁止**）                       |
| 5        | 一部 URL のみ失敗        | 成功分のみで続行（ただしログ必須）                     |
| 8        | ファクトチェック矛盾検出 | 却下推奨フラグを立てる（自動修正は**禁止**）           |
| 10       | HTML バリデーション失敗  | 失敗で停止（壊れた HTML 出力は禁止）                   |

---

## 非機能要件

### 可用性

| 項目           | 目標値      | 備考                      |
| -------------- | ----------- | ------------------------- |
| システム稼働率 | 95%（月次） | ローカル運用のため控えめ  |
| 障害検知時間   | 5分以内     | ヘルスチェック + アラート |
| 障害復旧目標   | 30分以内    | 手動対応前提              |

### パフォーマンス

| 項目             | 目標値   | 備考                         |
| ---------------- | -------- | ---------------------------- |
| 全工程所要時間   | 60分以内 | 承認待ち時間除く             |
| 工程単体最大時間 | 10分     | 工程7A（長文生成）が最長     |
| 同時実行 run 数  | 10       | 単一 Temporal クラスタの限界 |

### データ保持期間

| 対象     | 保持期間 | 備考          |
| -------- | -------- | ------------- |
| 完了 run | 1年      | 成果物 + ログ |
| 失敗 run | 3ヶ月    | デバッグ用    |
| 監査ログ | 3年      | 削除不可      |

### セキュリティ要件

| 項目           | 要件                               |
| -------------- | ---------------------------------- |
| テナント分離   | 物理的 DB 分離必須                 |
| API キー       | 暗号化保存、平文ログ禁止           |
| 入力サニタイズ | プロンプトインジェクション対策必須 |
| 監査ログ       | 改ざん防止必須                     |
