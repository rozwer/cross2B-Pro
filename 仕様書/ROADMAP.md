# SEO記事自動生成システム ロードマップ

> **最終更新**: 2025-12-29
>
> **運用前提**
>
> - 実装者：AI（主実装 ClaudeCode、コード調査・レビュー Codex）
> - 区切り：成果物（動く縦切り）+ ゲート条件（DoD）
> - 実装思想：分割実装→統合（境界・呼び出し・バリデーション・永続化・冪等性を先に固め、後から中身を埋める）
> - 並列実装：サブエージェント呼び出し + git worktree で衝突回避
> - **フォールバック全面禁止**：正常挙動以外は許可しない
> - ローカル運用固定：Postgres + MinIO + Temporal
> - マルチテナント：顧客別DBの物理分離を最初から採用

---

## 実装完了サマリー

| Phase | 内容 | ステータス | テスト数 |
|-------|------|----------|---------|
| Phase 1 | LLM API 呼び出し | ✅ 完了 | 77 |
| Phase 2 | ツール + 出力検証 | ✅ 完了 | 104 |
| Phase 3 | 契約・ストア・観測 | ✅ 完了 | - |
| Phase 4 | LangGraph 統合 | ✅ 完了 | 31 |
| Phase 5 | フロントエンド UI | ✅ 完了 | 37 |
| **合計** | - | **✅ 完了** | **323** |

---

## Phase 1: LLM API 呼び出しの有効化 ✅

### 目的

後続すべての工程で必要な「LLM呼び出し」を先に安定化する。

### 成果物

1. **プラットフォーム別クライアントモジュール**
   - Gemini（gemini-2.0-flash, gemini-2.5-pro 等）
   - OpenAI（gpt-4o, gpt-4-turbo, o3 等）
   - Anthropic（claude-sonnet-4, claude-opus-4 等）
   - Nano Banana（画像生成系）

2. **検証済みリクエストヘッダーJSON**
3. **オプション切替機構**（grounding 等）

### 完了条件 ✅

- [x] 各プラットフォームで「呼び出し→レスポンス取得」確認
- [x] grounding 等の重要オプション切替が動作
- [x] フォールバック経路が存在しない（明示選択のみ）
- [x] エラーハンドリングが統一フォーマット
- [x] 77テスト通過

---

## Phase 2: ツール + 出力検証 ✅

### 目的

検索・取得・抽出・検証など、LLM単体より強い処理をツール化し、出力の妥当性を保証する。

### 成果物

#### ツール

| tool_id | 機能 |
|---------|------|
| `serp_fetch` | SERP取得（上位N件URL） |
| `page_fetch` | ページ取得 + 本文抽出 |
| `primary_collector` | 一次情報収集器 |
| `url_verify` | URL実在確認 |
| `pdf_extract` | PDFテキスト抽出 |

#### 検証

| 形式 | 検査項目 |
|------|----------|
| JSON | 構文破損、スキーマ違反 |
| CSV | 列不一致、クオート崩れ |

### 完了条件 ✅

- [x] Tool Manifest で一意に呼び出し可能
- [x] SERP → 取得 → 抽出 → 保存が一連で通る
- [x] 失敗時に別手段へ自動切替しない
- [x] JSON/CSV 検証が機械可読
- [x] 104テスト通過

---

## Phase 3: 契約・ストア・観測 ✅

### 目的

共通契約（State / Context / Error / Retry）と成果物ストアを確定。

### 成果物

1. **Graph State スキーマ**
2. **ExecutionContext**
3. **エラー分類**（RETRYABLE / NON_RETRYABLE / VALIDATION_FAIL）
4. **Artifact Store I/F**（MinIO）
5. **DB スキーマ**（runs, steps, attempts, artifacts, events）
6. **Prompt Pack ローダ**

### 完了条件 ✅

- [x] 全出力が同一契約（GraphState）に載る
- [x] 失敗時に「再試行可能か」が機械判定できる
- [x] フォールバック経路が設計上存在しない
- [x] 型チェック（mypy）通過

---

## Phase 4: LangGraph 統合 ✅

### 目的

Phase 1-3 で分割実装した要素を組み立てて E2E の骨格を完成。

### 成果物

#### 2段構成 Graph

**pre-approval graph**
```
工程0（準備）→ 工程1（分析）→ 工程3（構成）→ 工程2（調査）
    → 工程3A/3B/3C（並列）→ [承認待ち State 保存]
```

**post-approval graph**
```
[承認後 State 復元]→ 工程4 → 工程5 → 工程6 → 工程6.5
    → 工程7A → 工程7B → 工程8 → 工程9 → 工程10
```

### 完了条件 ✅

- [x] `mock_pack` 指定で pre が完走し承認待ち State が保存
- [x] 承認後 post が進み、統合パッケージが生成・保存
- [x] 全工程で検証・保存・イベント記録
- [x] 31テスト通過

---

## Phase 5: フロントエンド UI ✅

### 目的

社内エンジニアが運用・デバッグできる UI を提供。

### 成果物

| 画面 | パス | 機能 |
|------|------|------|
| Runs一覧 | `/runs` | ステータスフィルター、更新 |
| Run作成 | `/runs/new` | 工程-1入力、オプション設定 |
| Run詳細 | `/runs/[id]` | StepTimeline、成果物、イベント |
| プレビュー | `/runs/[id]/preview` | 生成HTML確認 |

### 完了条件 ✅

- [x] UI から Run 作成 → 承認 → retry → Preview が可能
- [x] 自動切替や黙った回復が存在しない
- [x] 全画面でエラー状態が明示
- [x] 37テスト通過

---

## 今後の計画: 工程構成変更

> 詳細は `docs/migration/phase-plan.md` を参照

### 新規追加予定工程

| 工程 | 内容 | セッション |
|------|------|-----------|
| 工程-1 | ヒアリングUI | Session E |
| 工程1.5 | 関連KW競合抽出 | Session A |
| 工程3.5 | 人間味生成 | Session B |
| 工程12 | WordPress HTML | Session C |

### 変更予定工程

| 工程 | 変更内容 | セッション |
|------|----------|-----------|
| 工程10 | 4記事出力に変更 | Session D |
| 工程2,4,7A | 入力ファイル調整 | Session F |

### 実装優先度

```
Session A-E（並列実装可能）
    ↓
Session F（統合）
```

---

## テスト戦略

### テストレベル

| レベル | LLM | 頻度 | 目的 |
|--------|-----|------|------|
| ユニット | モック | 毎commit | ロジック検証 |
| 統合 | モック | 毎PR | ワークフロー構造 |
| E2E（smoke） | モック | 毎PR | 起動・疎通確認 |
| E2E（本番） | 実LLM | 毎週 | 実運用相当 |

### 特殊テスト

| テスト種別 | 目的 | 頻度 |
|-----------|------|------|
| 決定性テスト | digest一致確認 | 毎PR |
| フォールバック不在テスト | 静的検証 | 毎commit |
| マルチテナント分離テスト | 越境防止 | 毎PR |
| Temporal Replay テスト | 決定性違反検出 | 毎PR |

### カバレッジ目標

| 対象 | 目標 |
|------|------|
| クリティカルパス | 100% |
| 全体 | 80%以上 |

---

## 禁止事項（全工程共通）

| 禁止事項 | 確認項目 |
|----------|----------|
| 別モデルへの自動切替 | fallback model の記述がない |
| 別プロバイダへの自動切替 | fallback provider の記述がない |
| 別ツールへの自動切替 | fallback tool の記述がない |
| モックへの自動逃げ | mock は明示指定時のみ |
| 壊れた出力の黙った採用 | 修正時は必ずログ |
| prompt pack 未指定での自動実行 | 未指定時は例外 |

---

## 許容事項

| 許容事項 | 条件 |
|----------|------|
| 同一条件でのリトライ | 上限3回、attempt記録必須 |
| 決定的修正（JSON末尾カンマ除去等） | ログ必須、repair イベント記録 |
| 外部LLMによるフォーマット再生成 | 明示ON時のみ、上限あり |
