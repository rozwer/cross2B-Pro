# イベントログ改善（完了）

> **作成日**: 2026-01-15
> **完了日**: 2026-01-15
> **目的**: イベントログを実用的なものに改善し、リトライ/成功/エラー/修正ログを一元表示

---

## 概要

### 現状の問題点（解決済み）

1. **WebSocket経由のイベントのみ表示** - メモリ内保存、接続中のみ有効
2. **DB保存済みのaudit_logsが活用されていない** - REST APIはあるがUIが取得していない
3. **イベント種別が限定的** - リトライ詳細、修正ログ、LLMエラー詳細が不足
4. **永続化されていない表示** - ページリロードでイベントが消える

### 改善結果

- **すべてのログを一元表示**: リトライ、成功、エラー、修正ログ
- **DB永続化**: ページリロード後も履歴を確認可能
- **リアルタイム更新**: WebSocket経由で新規イベントを即時反映
- **フィルタリング**: イベント種別、ステップ、時間範囲でフィルター

---

## フェーズ1: バックエンド改善 ✅完了

### 1.1 イベントAPI拡張

- [x] `/api/runs/{run_id}/events` に追加フィルター
  - `event_type`: イベント種別フィルター
  - `since`: 指定時刻以降のイベント
  - `offset`: ページネーション対応
- [x] イベント詳細情報の拡充（duration_ms, attempt, error_details, step）
- [x] step-levelイベントの取得追加

### 1.2 Worker側イベント発行強化（既存機能活用）

- [x] 既存の`EventEmitter`でリトライ/エラー/修正ログを発行済み
- [ ] LLMエラーの詳細（モデル名、トークン使用量）- 将来対応

---

## フェーズ2: フロントエンド改善 ✅完了

### 2.1 イベント取得の改善

- [x] REST APIからDB保存済みイベントを取得
- [x] WebSocket経由の新規イベントと統合
- [x] 重複排除（タイムスタンプ+イベント種別で判定）

### 2.2 イベントログUIの改善

- [x] フィルター機能（成功/エラー/リトライ/開始/情報）
- [x] 詳細表示（エラー内容、理由、処理時間、リトライ回数）
- [x] 展開可能な詳細データ表示
- [x] LIVEバッジ（WebSocket経由のリアルタイムイベント識別）

---

## ファイル変更一覧

| ファイル | 変更 |
|----------|------|
| `apps/api/routers/events.py` | フィルター追加、詳細情報拡充 |
| `apps/worker/activities/base.py` | イベント発行強化 |
| `apps/ui/src/app/runs/[id]/page.tsx` | EventsList改善 |
| `apps/ui/src/hooks/useEvents.ts` | **新規** - イベント取得フック |
| `apps/ui/src/lib/api.ts` | events API拡張 |
