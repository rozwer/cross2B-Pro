{
  "report_metadata": {
    "title": "セキュリティ脆弱性調査レポート",
    "generated_at": "2025-12-16",
    "scope": "コードベース全体（.envファイルを除く）",
    "total_vulnerabilities": 9
  },
  "summary": {
    "critical": 3,
    "high": 3,
    "medium": 3,
    "low": 0
  },
  "vulnerabilities": [
    {
      "id": "VULN-001",
      "severity": "critical",
      "category": "XSS",
      "title": "HTMLの直接レンダリングによるXSS脆弱性",
      "file": "apps/ui/src/components/artifacts/HtmlPreview.tsx",
      "line": "45-49",
      "description": "srcDoc属性にユーザー/LLM生成のHTMLを直接渡している。sandbox=\"allow-same-origin\"は同一オリジンでのスクリプト実行を許可する可能性がある。",
      "vulnerable_code": "<iframe srcDoc={content} sandbox=\"allow-same-origin\" />",
      "impact": [
        "悪意あるHTMLコンテンツによるXSS攻撃",
        "セッション情報の窃取",
        "フィッシング攻撃"
      ],
      "remediation": {
        "description": "sandbox属性を強化し、HTMLをサニタイズする",
        "recommended_code": "<iframe srcDoc={DOMPurify.sanitize(content)} sandbox=\"\" />",
        "alternatives": [
          "DOMPurifyなどでHTMLをサニタイズしてから表示",
          "sandbox属性を空文字列に設定（最も制限的）"
        ]
      },
      "cwe": "CWE-79",
      "owasp": "A03:2021 - Injection"
    },
    {
      "id": "VULN-002",
      "severity": "critical",
      "category": "SSRF",
      "title": "Server-Side Request Forgery脆弱性",
      "file": "apps/api/tools/fetch.py",
      "line": "133-164",
      "description": "page_fetchツールでURL検証が不十分。内部ネットワークやクラウドメタデータサービスへのアクセスが可能。",
      "vulnerable_code": "parsed = urlparse(url)\nif not parsed.scheme or not parsed.netloc:\n    return ToolResult(...)\nresponse = await client.get(url, headers=headers)",
      "impact": [
        "内部サービスへの不正アクセス",
        "AWSなどのクラウドメタデータ取得によるクレデンシャル漏洩（169.254.169.254）",
        "内部ネットワークのスキャン",
        "ファイアウォールのバイパス"
      ],
      "remediation": {
        "description": "内部ネットワークとクラウドメタデータへのアクセスを禁止する",
        "recommended_code": "BLOCKED_HOSTS = ['127.0.0.1', 'localhost', '0.0.0.0', '169.254.169.254']\nBLOCKED_NETWORKS = ['10.', '172.16.', '192.168.', '::1']\n\ndef is_safe_url(url: str) -> bool:\n    parsed = urlparse(url)\n    host = parsed.hostname\n    if host in BLOCKED_HOSTS:\n        return False\n    for network in BLOCKED_NETWORKS:\n        if host and host.startswith(network):\n            return False\n    return True",
        "alternatives": [
          "URLの許可リスト（allowlist）を実装",
          "DNSリバインディング対策を追加"
        ]
      },
      "cwe": "CWE-918",
      "owasp": "A10:2021 - Server-Side Request Forgery"
    },
    {
      "id": "VULN-003",
      "severity": "critical",
      "category": "Path Traversal",
      "title": "パストラバーサル脆弱性",
      "file": "apps/api/tools/fetch.py",
      "line": "366-374",
      "description": "pdf_pathパラメータにユーザー入力が渡されると、任意のファイルを読み取り可能。",
      "vulnerable_code": "path = Path(pdf_path)\nif not path.exists():\n    return ToolResult(...)\npdf_data = path.read_bytes()",
      "impact": [
        "システムファイルの漏洩（/etc/passwd等）",
        "設定ファイル（.env、credentials等）の漏洩",
        "ソースコードの漏洩"
      ],
      "remediation": {
        "description": "ファイルパスを許可されたディレクトリに制限する",
        "recommended_code": "import os\nALLOWED_DIRS = ['/data/pdfs/', '/uploads/']\n\ndef is_safe_path(pdf_path: str) -> bool:\n    resolved = os.path.realpath(pdf_path)\n    return any(resolved.startswith(d) for d in ALLOWED_DIRS)",
        "alternatives": [
          "ファイル名のみを受け付け、ディレクトリは固定",
          "UUIDベースのファイル参照を使用"
        ]
      },
      "cwe": "CWE-22",
      "owasp": "A01:2021 - Broken Access Control"
    },
    {
      "id": "VULN-004",
      "severity": "high",
      "category": "SQL Injection",
      "title": "SQLインジェクションのリスク",
      "file": "apps/api/db/tenant.py",
      "line": "189, 260",
      "description": "CREATE DATABASE/DROP DATABASE文でf-stringを使用してSQL構築。tenant_idの検証が不十分な場合に危険。",
      "vulnerable_code": "conn.execute(text(f'CREATE DATABASE \"{db_name}\"'))\nconn.execute(text(f'DROP DATABASE IF EXISTS \"{db_name}\"'))",
      "impact": [
        "データベースの不正操作",
        "データの漏洩・改ざん・削除",
        "権限昇格"
      ],
      "remediation": {
        "description": "tenant_idの形式を厳密に検証する",
        "recommended_code": "import re\nif not re.match(r'^[a-zA-Z0-9\\-]+$', tenant_id):\n    raise ValueError('Invalid tenant_id format')",
        "alternatives": [
          "tenant_idをUUID形式に統一",
          "許可された文字のみを受け付けるバリデーション"
        ]
      },
      "cwe": "CWE-89",
      "owasp": "A03:2021 - Injection",
      "mitigating_factors": [
        "db_nameはseo_gen_tenant_{tenant_id}形式で構築",
        "tenant_idは認証から取得する想定"
      ]
    },
    {
      "id": "VULN-005",
      "severity": "high",
      "category": "Authentication",
      "title": "API認証の欠如",
      "file": "apps/ui/src/lib/api.ts",
      "line": "20-46",
      "description": "APIクライアントに認証トークン（Bearer token等）を付与するロジックがない。",
      "vulnerable_code": "const headers: HeadersInit = {\n  'Content-Type': 'application/json',\n  ...options.headers,\n};",
      "impact": [
        "認証バイパス",
        "他テナントのデータへのアクセス",
        "不正なAPI操作"
      ],
      "remediation": {
        "description": "JWTトークンをリクエストヘッダーに含める",
        "recommended_code": "const headers: HeadersInit = {\n  'Content-Type': 'application/json',\n  'Authorization': `Bearer ${getAuthToken()}`,\n  ...options.headers,\n};",
        "alternatives": [
          "httpOnlyクッキーによる認証",
          "リフレッシュトークンの仕組みを実装"
        ]
      },
      "cwe": "CWE-306",
      "owasp": "A07:2021 - Identification and Authentication Failures"
    },
    {
      "id": "VULN-006",
      "severity": "high",
      "category": "Authentication",
      "title": "WebSocket認証の欠如",
      "file": "apps/ui/src/lib/websocket.ts",
      "line": "40-43",
      "description": "WebSocket接続に認証情報が含まれていない。runIdを知っていれば誰でも進捗情報を取得可能。",
      "vulnerable_code": "const url = `${WS_BASE}/ws/runs/${this.runId}`;\nthis.ws = new WebSocket(url);",
      "impact": [
        "認証バイパス",
        "他ユーザーのワークフロー進捗の監視",
        "情報漏洩"
      ],
      "remediation": {
        "description": "URLパラメータまたはsubprotocolでトークンを送信",
        "recommended_code": "const url = `${WS_BASE}/ws/runs/${this.runId}?token=${authToken}`;",
        "alternatives": [
          "WebSocket subprotocolでトークンを送信",
          "最初のメッセージで認証を行う"
        ]
      },
      "cwe": "CWE-306",
      "owasp": "A07:2021 - Identification and Authentication Failures"
    },
    {
      "id": "VULN-007",
      "severity": "medium",
      "category": "XSS",
      "title": "MarkdownレンダリングのXSSリスク",
      "file": "apps/ui/src/components/artifacts/MarkdownViewer.tsx",
      "line": "1-183",
      "description": "カスタムMarkdownパーサーを使用。現在はReactの自動エスケープで保護されているが、リンク処理などの機能追加時にXSSリスクが発生する可能性。",
      "vulnerable_code": "const renderMarkdown = (text: string) => {...}",
      "impact": [
        "将来的なXSS脆弱性の導入リスク",
        "メンテナンス性の低下"
      ],
      "remediation": {
        "description": "信頼できるMarkdownライブラリを使用する",
        "recommended_code": "import ReactMarkdown from 'react-markdown'\nimport rehypeSanitize from 'rehype-sanitize'\n\n<ReactMarkdown rehypePlugins={[rehypeSanitize]}>{content}</ReactMarkdown>",
        "alternatives": []
      },
      "cwe": "CWE-79",
      "owasp": "A03:2021 - Injection",
      "mitigating_factors": [
        "ReactがJSXの文字列を自動的にエスケープ",
        "現在はリンク処理が未実装"
      ]
    },
    {
      "id": "VULN-008",
      "severity": "medium",
      "category": "CORS",
      "title": "CORS設定の不足",
      "file": "バックエンド全体",
      "line": "N/A",
      "description": "バックエンドのCORS設定ファイルが確認できない。適切でない場合、悪意あるサイトからのAPIアクセスが可能。",
      "vulnerable_code": "N/A",
      "impact": [
        "クロスオリジンからの不正なAPIアクセス",
        "CSRF攻撃のリスク"
      ],
      "remediation": {
        "description": "許可するオリジンを明示的に指定する",
        "recommended_code": "from fastapi.middleware.cors import CORSMiddleware\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=['https://example.com'],\n    allow_credentials=True,\n    allow_methods=['GET', 'POST', 'PUT', 'DELETE'],\n    allow_headers=['*'],\n)",
        "alternatives": []
      },
      "cwe": "CWE-346",
      "owasp": "A05:2021 - Security Misconfiguration"
    },
    {
      "id": "VULN-009",
      "severity": "medium",
      "category": "Information Disclosure",
      "title": "エラーメッセージによる情報漏洩",
      "file": "複数ファイル",
      "line": "N/A",
      "description": "内部エラーの詳細がユーザーに露出している。スタックトレースやファイルパスが漏洩する可能性。",
      "vulnerable_code": "error_message=f'Network error: {e}'\nerror_message=f'PDF extraction failed: {e}'",
      "impact": [
        "内部システム構造の漏洩",
        "攻撃者への情報提供",
        "ファイルパスの漏洩"
      ],
      "remediation": {
        "description": "ユーザー向けエラーメッセージと内部ログを分離する",
        "recommended_code": "# 内部ログ\nlogger.error(f'PDF extraction failed: {e}', exc_info=True)\n\n# ユーザー向け\nreturn ToolResult(\n    success=False,\n    error_message='ファイルの処理中にエラーが発生しました'\n)",
        "alternatives": [
          "環境変数で詳細エラーの表示を制御",
          "エラーIDを発行してユーザーに表示、詳細は内部ログに記録"
        ]
      },
      "cwe": "CWE-209",
      "owasp": "A05:2021 - Security Misconfiguration"
    }
  ],
  "positive_findings": [
    {
      "category": "SQL Injection Prevention",
      "description": "大部分のDBアクセスがSQLAlchemy ORM経由でSQLインジェクション対策済み"
    },
    {
      "category": "Parameterized Queries",
      "description": "text()使用箇所でも:param形式のパラメータ化クエリを多用"
    },
    {
      "category": "HTTPS Redirect",
      "description": "follow_redirects=Trueで安全なリダイレクト処理を実装"
    },
    {
      "category": "Content-Type Validation",
      "description": "HTMLコンテンツタイプをチェックしている"
    },
    {
      "category": "Timeout Configuration",
      "description": "HTTP/WebSocket接続にタイムアウトを適切に設定"
    },
    {
      "category": "Dependency Management",
      "description": "主要パッケージは比較的新しいバージョンを使用"
    }
  ],
  "recommended_actions": {
    "immediate": [
      {
        "priority": "P0",
        "action": "XSS: iframe sandbox属性の強化 + HTMLサニタイズ実装",
        "file": "apps/ui/src/components/artifacts/HtmlPreview.tsx"
      },
      {
        "priority": "P0",
        "action": "SSRF: 内部ネットワーク/クラウドメタデータへのアクセス遮断",
        "file": "apps/api/tools/fetch.py"
      },
      {
        "priority": "P0",
        "action": "パストラバーサル: ファイルパスの許可リスト実装",
        "file": "apps/api/tools/fetch.py"
      }
    ],
    "short_term": [
      {
        "priority": "P1",
        "action": "API認証: JWTトークンの付与",
        "file": "apps/ui/src/lib/api.ts"
      },
      {
        "priority": "P1",
        "action": "WebSocket認証: トークンによる認証",
        "file": "apps/ui/src/lib/websocket.ts"
      },
      {
        "priority": "P1",
        "action": "SQLインジェクション: tenant_id形式の検証",
        "file": "apps/api/db/tenant.py"
      }
    ],
    "medium_term": [
      {
        "priority": "P2",
        "action": "CORS: 適切なオリジン制限",
        "file": "バックエンド全体"
      },
      {
        "priority": "P2",
        "action": "エラーメッセージ: 詳細情報の隠蔽",
        "file": "複数ファイル"
      },
      {
        "priority": "P3",
        "action": "Markdown: 安全なライブラリへの移行",
        "file": "apps/ui/src/components/artifacts/MarkdownViewer.tsx"
      }
    ]
  }
}
