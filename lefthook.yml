# lefthook.yml - Git hooks configuration
# Migrated from .githooks/
# See: https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    # 秘密情報検出（カスタムスクリプト）
    secrets:
      run: bash .lefthook/check-secrets.sh {staged_files}
      glob: "*"

    # Python: ruff lint + format（修正後に自動再ステージ）
    ruff-check:
      glob: "*.py"
      run: ruff check {staged_files} --fix
      stage_fixed: true

    ruff-format:
      glob: "*.py"
      run: ruff format {staged_files}
      stage_fixed: true

    # Python: mypy（Phase 1: 警告のみ、CI で必須化予定）
    mypy:
      glob: "*.py"
      run: mypy {staged_files} --ignore-missing-imports || true
      # TODO: Phase 2 で || true を削除し、CI でも必須化

    # TypeScript: Biome format（repo ルートから実行、config-path 指定）
    biome:
      glob: "apps/ui/**/*.{ts,tsx}"
      run: mise exec -- npx biome format --write --config-path apps/ui/biome.json {staged_files}
      stage_fixed: true

    # TypeScript: tsc（Phase 1: 警告のみ、CI で必須化予定）
    tsc:
      glob: "apps/ui/**/*.{ts,tsx}"
      run: cd apps/ui && mise exec -- npx tsc --noEmit || true
      # TODO: Phase 2 で || true を削除し、CI でも必須化

    # JSON 検証（複数ファイル対応: for ループ）
    json:
      glob: "*.json"
      run: |
        for f in {staged_files}; do
          python3 -m json.tool "$f" > /dev/null || exit 1
        done

prepare-commit-msg:
  commands:
    prefix:
      run: bash .lefthook/prepare-commit-msg.sh {1}

commit-msg:
  commands:
    conventional:
      run: bash .lefthook/commit-msg.sh {1}

pre-push:
  commands:
    # main/master 直 push 禁止
    protected-branch:
      run: bash .lefthook/check-protected-branch.sh

    # smoke テスト
    smoke:
      run: uv run pytest tests/smoke/ -q --tb=no || echo "Smoke tests skipped"