# 設計思想

> Claude Code の `.claude` ディレクトリ構成における設計原則と思想

---

## 1. 階層化原則

### 優先度の明確化

```
CLAUDE.md（最高優先度）
    ↓
Rules（常時適用）
    ↓
Skills / Agents / Commands（必要時に参照）
    ↓
Settings（パーミッション）
```

**CLAUDE.md は全ての指示書の最上位に位置する**。他のドキュメントと矛盾がある場合、CLAUDE.md を正とする。

### 責務の分離

| 階層 | 責務 | 読み込みタイミング |
|------|------|-------------------|
| CLAUDE.md | プロジェクト全体の方針・制約 | セッション開始時 |
| Rules | ドメイン別の詳細ルール | セッション開始時（自動） |
| Skills | ユーザー向けワークフロー | 明示的呼び出し時 |
| Agents | 内部処理の専門家 | Task ツール経由 |
| Commands | 短縮形・引数付き操作 | スラッシュコマンド時 |

---

## 2. 汎用と専門の分離

### template/（汎用資産）

**特徴**:
- プロジェクトを問わず使える
- そのままコピーして動作する
- カスタマイズは任意

**含まれるもの**:
- Git 操作スキル（commit, pr, push）
- 開発ワークフロー（fix-bug, refactor, review）
- 汎用エージェント（docker-manager, log-investigator）
- 基本ルール（dev-style, git-worktree）
- セキュリティフック

### blueprint/（専門資産）

**特徴**:
- プロジェクト固有のカスタマイズが必須
- テンプレートとして提供
- 変数やプレースホルダーを含む

**含まれるもの**:
- CLAUDE.md テンプレート
- ドメイン固有スキル
- 専門エージェント
- 実装ルール（API 契約、テスト戦略）

### 分離の理由

1. **再利用性**: 汎用資産は複数プロジェクトで共有可能
2. **保守性**: 汎用資産の更新を一括で反映できる
3. **明確性**: カスタマイズが必要な箇所が明確
4. **品質**: 汎用資産はテスト済みで信頼性が高い

---

## 3. 構成要素の役割

### Skills（ユーザー向けワークフロー）

**呼び出し方**: `/skill-name`

**役割**:
- 複数ステップの作業をガイド付きで実行
- エージェントの組み合わせをオーケストレーション
- ユーザーとの対話を含む

**設計指針**:
- 1 スキル = 1 つの完結したワークフロー
- 動詞始まりの命名（fix-, add-, run-）
- 実行フローを明示

**例**:
```markdown
/commit → コミット作成ワークフロー
/pr → プルリクエスト作成
/fix-bug → バグ修正フロー
```

### Agents（内部処理の専門家）

**呼び出し方**: `@agent-name` または Task ツール経由

**役割**:
- 特定ドメインの専門知識を持つ
- 単一の責務に集中
- Skills から呼び出される

**設計指針**:
- 1 エージェント = 1 つの専門領域
- 役割を表す接尾辞（-implementer, -reviewer, -manager）
- 入出力を明確に定義

**例**:
```markdown
@codex-reviewer → セカンドオピニオンレビュー
@docker-manager → Docker 管理
@security-reviewer → セキュリティ監査
```

### Commands（短縮形・引数付き操作）

**呼び出し方**: `/namespace:command`

**役割**:
- 頻繁に使う操作の短縮形
- 引数を受け取る操作
- シンプルな単一タスク

**設計指針**:
- namespace でグルーピング
- 短く明確な名前
- 1 コマンド = 1 アクション

**例**:
```markdown
/dev:up → Docker 起動
/dev:down → Docker 停止
/dev:logs → ログ表示
/workflow:run → ワークフロー実行
```

### Rules（常時適用されるルール）

**呼び出し方**: 自動読み込み

**役割**:
- セッション全体に適用される制約
- 暗黙の前提として機能
- Skills/Agents/Commands の動作を制約

**設計指針**:
- 対象を明確にした命名
- 禁止事項と許可事項を明記
- 具体的な例を含める

**例**:
```markdown
dev-style.md → パッケージ管理・コミット方針
git-worktree.md → 並列開発ルール
implementation.md → 実装詳細ルール
```

### Hooks（ツール実行時のガード）

**呼び出し方**: 自動実行

**役割**:
- ツール実行前後の検証
- セキュリティガード
- 品質チェック

**設計指針**:
- PreToolUse: 実行前の検証
- PostToolUse: 実行後の検証
- Stop: セッション終了時の処理

**例**:
```markdown
PreToolUse: 危険なコマンドの検出
PostToolUse: 秘密情報の漏洩チェック
Stop: クリーンアップ処理
```

---

## 4. 最小限の設定（Permissions）

### 原則

1. **最小権限の原則**: 必要な権限のみを許可
2. **明示的な許可**: 暗黙の許可を避ける
3. **パターンベース**: 個別コマンドより汎用パターン

### settings.json の設計

```json
{
  "permissions": {
    "allow": [
      "Bash(git *)",      // Git 操作
      "Bash(docker *)",   // Docker 操作
      "Bash(uv *)",       // Python 管理
      "Bash(npm *)",      // Node 管理
      "Read",             // ファイル読み取り
      "Edit",             // ファイル編集
      "Write",            // ファイル書き込み
      "Glob",             // ファイル検索
      "Grep",             // コンテンツ検索
      "Task",             // サブタスク実行
      "Skill"             // スキル呼び出し
    ],
    "deny": [
      "Bash(rm -rf /)",   // 危険な削除
      "Bash(*secret*)",   // 秘密情報操作
      "Bash(*password*)"  // パスワード操作
    ]
  }
}
```

### settings.local.json の役割

- プロジェクト固有の追加許可
- 開発時の一時的な許可
- 定期的なクリーンアップが必要

---

## 5. セキュリティ第一

### Hooks によるガード

```
┌─────────────────────────────────────────────────────────┐
│                    ツール実行要求                        │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│  PreToolUse Hook                                        │
│  - 危険なコマンド検出                                    │
│  - 秘密情報の入力検出                                    │
│  - テナント越境チェック                                  │
└─────────────────────────────────────────────────────────┘
                           ↓
                    [許可] / [拒否]
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    ツール実行                            │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│  PostToolUse Hook                                       │
│  - 出力の秘密情報チェック                                │
│  - ログ記録                                              │
│  - 監査証跡                                              │
└─────────────────────────────────────────────────────────┘
```

### セキュリティ原則

1. **入力検証**: ユーザー入力を信用しない
2. **出力検証**: 秘密情報の漏洩を防ぐ
3. **監査証跡**: 重要操作をログに記録
4. **テナント分離**: マルチテナント環境での越境防止

---

## 6. 再現性（Plans.md）

### 計画の明示

```markdown
# Plans.md

## 現在のタスク

- [ ] タスク 1: 説明
- [ ] タスク 2: 説明

## 完了したタスク

- [x] タスク 0: 説明
```

### 再現性の保証

1. **計画の記録**: 何をしようとしているかを明示
2. **進捗の追跡**: 完了状態を記録
3. **意思決定の記録**: なぜその判断をしたか
4. **セッション継続**: 中断しても再開可能

### Claude-mem との連携

- セッション間でコンテキストを保持
- 過去の意思決定を参照可能
- パターンの再利用

---

## 7. フォールバック禁止

### 原則

```
❌ 禁止：
- 別モデル/別プロバイダへの自動切替
- モックへの逃げ
- 壊れた出力の黙った採用

✅ 許容：
- 同一条件でのリトライ（上限3回、ログ必須）
- 決定的修正（JSON末尾カンマ除去等、ログ必須）
```

### 理由

1. **予測可能性**: 動作が予測可能である
2. **デバッグ容易性**: 問題の原因が特定しやすい
3. **品質保証**: 品質の低下を防ぐ
4. **透明性**: 何が起きているかが明確

---

## 8. 拡張性

### 新規資産の追加

1. **汎用資産**: `template/` に追加してテスト
2. **専門資産**: `blueprint/` にテンプレートとして追加
3. **ドキュメント更新**: README.md と関連文書を更新

### バージョニング

- 資産のバージョンは Git で管理
- 破壊的変更は明示的に通知
- 後方互換性を維持

### プラグイン連携

- claude-mem: 永続メモリ
- claude-code-harness: 開発ハーネス
- superpowers: 追加スキル
- pr-review-toolkit: PR レビュー

---

## まとめ

| 原則 | 内容 |
|------|------|
| 階層化 | CLAUDE.md を頂点とした明確な優先度 |
| 分離 | 汎用（template）と専門（blueprint） |
| 最小設定 | 必要な権限のみを明示的に許可 |
| セキュリティ | Hooks によるガードと監査 |
| 再現性 | Plans.md と Claude-mem による継続性 |
| フォールバック禁止 | 予測可能で透明な動作 |
| 拡張性 | 新規資産の追加とプラグイン連携 |
