---
name: integration-test
description: フロントエンド・バックエンド統合テストガイド
---

# /integration-test - 統合テストスキル

> {{FRONTEND_FRAMEWORK}} と {{BACKEND_FRAMEWORK}} の統合テストを作成・実行するためのガイドライン

---

## 概要

統合テストは、複数のコンポーネント（API、DB、外部サービス）が正しく連携することを検証します。
E2E テストより軽量で、ユニットテストより実際の動作に近い検証が可能です。

---

## 使用方法

```bash
/integration-test <action> [options]
```

### アクション一覧

| アクション | 説明 |
|-----------|------|
| `new <feature>` | 新規統合テスト作成 |
| `run` | 全統合テスト実行 |
| `run <path>` | 指定パスのテスト実行 |
| `setup` | テスト環境セットアップ |

---

## テスト構造

```
tests/
├── integration/                # 統合テスト
│   ├── conftest.py             # 共通フィクスチャ
│   ├── test_user_flow.py       # ユーザー登録〜ログインフロー
│   ├── test_order_flow.py      # 注文フロー
│   └── test_payment_flow.py    # 決済フロー
├── fixtures/
│   └── integration/            # 統合テスト用データ
│       ├── scenarios/          # シナリオデータ
│       └── seeds/              # シードデータ
└── docker/
    └── test-compose.yml        # テスト用 Docker Compose
```

---

## 統合テストの種類

### 1. API + DB 統合

実際の DB（テスト用）を使用した API テスト。

{{API_DB_INTEGRATION_PATTERN}}

<!-- 使用例:
```python
import pytest
from sqlalchemy.ext.asyncio import AsyncSession
from httpx import AsyncClient

@pytest.fixture(scope="session")
async def test_db():
    """テスト用 DB（セッション単位で共有）"""
    # DB 作成・マイグレーション
    await create_test_database()
    yield
    # クリーンアップ
    await drop_test_database()

@pytest.fixture
async def db_session(test_db):
    """トランザクション付きセッション"""
    async with async_session_maker() as session:
        async with session.begin():
            yield session
            await session.rollback()

class TestUserRegistrationFlow:
    """ユーザー登録フローの統合テスト"""

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_full_registration_flow(self, client, db_session):
        """登録 → 確認メール → アクティベート → ログイン"""
        # 1. ユーザー登録
        register_response = await client.post("/api/auth/register", json={
            "email": "new@example.com",
            "password": "SecurePass123!"
        })
        assert register_response.status_code == 201
        user_id = register_response.json()["id"]

        # 2. 確認トークン取得（DB から直接）
        user = await db_session.get(User, user_id)
        assert user.is_active is False
        token = user.verification_token

        # 3. アカウントアクティベート
        activate_response = await client.post(
            f"/api/auth/activate?token={token}"
        )
        assert activate_response.status_code == 200

        # 4. ログイン確認
        login_response = await client.post("/api/auth/login", json={
            "email": "new@example.com",
            "password": "SecurePass123!"
        })
        assert login_response.status_code == 200
        assert "access_token" in login_response.json()
```
-->

---

### 2. フロントエンド + API 統合

React Testing Library/Vue Test Utils でコンポーネントと API の統合をテスト。

{{FRONTEND_API_INTEGRATION_PATTERN}}

<!-- 使用例（React）:
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { UserList } from '@/components/UserList';

const server = setupServer(
  rest.get('/api/users', (req, res, ctx) => {
    return res(ctx.json([
      { id: 1, name: 'Alice' },
      { id: 2, name: 'Bob' },
    ]));
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('UserList Integration', () => {
  it('fetches and displays users from API', async () => {
    render(<UserList />);

    // ローディング状態
    expect(screen.getByText('Loading...')).toBeInTheDocument();

    // データ取得後
    await waitFor(() => {
      expect(screen.getByText('Alice')).toBeInTheDocument();
      expect(screen.getByText('Bob')).toBeInTheDocument();
    });
  });

  it('handles API error gracefully', async () => {
    server.use(
      rest.get('/api/users', (req, res, ctx) => {
        return res(ctx.status(500));
      })
    );

    render(<UserList />);

    await waitFor(() => {
      expect(screen.getByText('Error loading users')).toBeInTheDocument();
    });
  });
});
```
-->

---

### 3. サービス間統合

複数のマイクロサービス/外部サービスとの統合。

{{SERVICE_INTEGRATION_PATTERN}}

<!-- 使用例:
```python
import pytest
from testcontainers.compose import DockerCompose

@pytest.fixture(scope="session")
def docker_services():
    """Docker Compose で依存サービスを起動"""
    with DockerCompose("tests/docker", compose_file_name="test-compose.yml") as compose:
        compose.wait_for("http://localhost:9000/health")  # MinIO
        compose.wait_for("http://localhost:8080/health")  # 外部サービス
        yield compose

class TestFileUploadFlow:
    """ファイルアップロードフロー"""

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_upload_and_process(self, client, docker_services, auth_headers):
        """アップロード → 処理 → 結果取得"""
        # 1. ファイルアップロード
        with open("tests/fixtures/sample.pdf", "rb") as f:
            response = await client.post(
                "/api/files/upload",
                files={"file": ("sample.pdf", f, "application/pdf")},
                headers=auth_headers
            )
        assert response.status_code == 201
        file_id = response.json()["id"]

        # 2. 処理完了を待機
        import asyncio
        for _ in range(10):
            status = await client.get(f"/api/files/{file_id}/status", headers=auth_headers)
            if status.json()["status"] == "completed":
                break
            await asyncio.sleep(1)
        else:
            pytest.fail("Processing timeout")

        # 3. 結果取得
        result = await client.get(f"/api/files/{file_id}/result", headers=auth_headers)
        assert result.status_code == 200
        assert "text" in result.json()
```
-->

---

## テスト環境セットアップ

### Docker Compose（テスト用）

```yaml
# tests/docker/test-compose.yml
version: '3.8'
services:
  test-db:
    image: postgres:15
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_db
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data

  test-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"

  test-minio:
    image: minio/minio
    command: server /data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9001:9000"
```

### 起動コマンド

```bash
# テスト環境起動
docker compose -f tests/docker/test-compose.yml up -d

# 統合テスト実行
{{RUN_INTEGRATION_TESTS}}

# テスト環境停止
docker compose -f tests/docker/test-compose.yml down -v
```

---

## フィクスチャ設計

### シナリオベースのフィクスチャ

```python
@pytest.fixture
async def order_scenario(db_session):
    """注文シナリオのセットアップ"""
    # ユーザー作成
    user = await create_user(db_session, "buyer@example.com")

    # 商品作成
    products = await create_products(db_session, [
        {"name": "Product A", "price": 1000},
        {"name": "Product B", "price": 2000},
    ])

    # カート作成
    cart = await create_cart(db_session, user.id, [
        {"product_id": products[0].id, "quantity": 2},
        {"product_id": products[1].id, "quantity": 1},
    ])

    return {
        "user": user,
        "products": products,
        "cart": cart,
        "expected_total": 4000,
    }
```

---

## マーカーと実行

### pytest マーカー

```python
# conftest.py
def pytest_configure(config):
    config.addinivalue_line("markers", "integration: 統合テスト")
    config.addinivalue_line("markers", "slow: 実行時間が長いテスト")
    config.addinivalue_line("markers", "docker: Docker が必要なテスト")

# pytest.ini
[pytest]
markers =
    integration: 統合テスト
    slow: 実行時間が長いテスト
    docker: Docker が必要なテスト
```

### 実行コマンド

```bash
# 統合テストのみ実行
{{RUN_INTEGRATION_TESTS}}

# Docker 依存テスト除外
{{RUN_WITHOUT_DOCKER}}

# 遅いテスト除外
{{RUN_FAST_ONLY}}
```

<!-- 使用例（pytest）:
{{RUN_INTEGRATION_TESTS}} = uv run pytest tests/integration/ -v -m integration
{{RUN_WITHOUT_DOCKER}} = uv run pytest tests/integration/ -v -m "integration and not docker"
{{RUN_FAST_ONLY}} = uv run pytest tests/integration/ -v -m "integration and not slow"
-->

---

## ベストプラクティス

### DO（推奨）

```
- テスト用 DB を使用（本番 DB は使わない）
- Docker Compose でサービスを分離
- トランザクションでロールバック
- シナリオ単位でフィクスチャを設計
- 外部サービスはモック or テストコンテナ
```

### DON'T（非推奨）

```
- 本番環境のサービスに依存
- テスト間で状態を共有
- ネットワーク依存のテスト（外部 API 直接呼び出し）
- 長時間の sleep() 使用
- 固定ポート番号のハードコード
```

---

## トラブルシューティング

| 症状 | 原因 | 解決策 |
|------|------|--------|
| DB 接続エラー | コンテナ未起動 | `docker compose up -d` で起動 |
| ポート競合 | 他プロセス使用中 | ポート番号変更 or 停止 |
| タイムアウト | 処理が遅い | タイムアウト値を調整 |
| データ不整合 | ロールバック漏れ | フィクスチャスコープ確認 |

---

## 関連スキル

| スキル | 説明 |
|--------|------|
| `/api-test` | API ユニットテスト |
| `/e2e-test` | E2E テスト |

---

## 変数一覧

| 変数名 | 説明 | 必須 |
| ------ | ---- | ---- |
| `{{BACKEND_FRAMEWORK}}` | バックエンドフレームワーク | YES |
| `{{FRONTEND_FRAMEWORK}}` | フロントエンドフレームワーク | YES |
| `{{TEST_FRAMEWORK}}` | テストフレームワーク | YES |
| `{{API_DB_INTEGRATION_PATTERN}}` | API+DB 統合パターン | YES |
| `{{FRONTEND_API_INTEGRATION_PATTERN}}` | FE+API 統合パターン | YES |
| `{{SERVICE_INTEGRATION_PATTERN}}` | サービス間統合パターン | YES |
| `{{RUN_INTEGRATION_TESTS}}` | 統合テスト実行コマンド | YES |
| `{{RUN_WITHOUT_DOCKER}}` | Docker なし実行コマンド | YES |
| `{{RUN_FAST_ONLY}}` | 高速テストのみ実行コマンド | YES |
