---
name: {{WORKFLOW_FRAMEWORK_LOWER}}-patterns
description: {{WORKFLOW_FRAMEWORK}} のよく使うパターン集
---

# /{{WORKFLOW_FRAMEWORK_LOWER}}-patterns - パターン集

> {{WORKFLOW_FRAMEWORK}} でよく使うパターンとエラーハンドリング

---

## 概要

このスキルは `options.json` の `workflow_framework` 設定に基づいて展開されます。
{{WORKFLOW_FRAMEWORK}} を使用したワークフロー開発でよく使うパターンを提供します。

---

## 条件分岐パターン

### シンプルな条件分岐

```
{{PATTERN_CONDITIONAL_SIMPLE}}
```

<!-- 使用例:
# LangGraph の場合
def route_by_type(state: MyState) -> str:
    if state["type"] == "A":
        return "process_a"
    else:
        return "process_b"

graph.add_conditional_edges(
    "classifier",
    route_by_type,
    {"process_a": "node_a", "process_b": "node_b"}
)

# Airflow の場合
@task.branch
def branch_task(value):
    if value > 10:
        return "high_value_task"
    return "low_value_task"
-->

### 複数条件の分岐

```
{{PATTERN_CONDITIONAL_MULTI}}
```

<!-- 使用例:
# LangGraph の場合
def route_by_status(state: MyState) -> str:
    status = state["status"]
    if status == "approved":
        return "next_step"
    elif status == "rejected":
        return "notify_rejection"
    elif status == "pending":
        return "wait_approval"
    else:
        return "error_handler"
-->

---

## ループパターン

### 条件付きループ

```
{{PATTERN_LOOP_CONDITIONAL}}
```

<!-- 使用例:
# LangGraph の場合
def should_continue(state: MyState) -> str:
    if state["retry_count"] >= 3:
        return "fail"
    if state["quality_score"] >= 0.8:
        return "success"
    return "retry"

graph.add_conditional_edges(
    "evaluate",
    should_continue,
    {"retry": "generate", "success": END, "fail": "error_handler"}
)
-->

### 反復処理（リスト処理）

```
{{PATTERN_LOOP_ITERATE}}
```

<!-- 使用例:
# LangGraph の場合
def process_items(state: MyState) -> MyState:
    items = state["items"]
    current_index = state.get("current_index", 0)

    if current_index >= len(items):
        return {"processing_complete": True}

    result = process_item(items[current_index])
    return {
        "results": [result],  # Annotated[list, add] で追加
        "current_index": current_index + 1
    }
-->

---

## 並列実行パターン

### 並列ノード実行

```
{{PATTERN_PARALLEL_NODES}}
```

<!-- 使用例:
# LangGraph の場合
graph.add_node("task_a", task_a_node)
graph.add_node("task_b", task_b_node)
graph.add_node("task_c", task_c_node)

# 同一ノードから複数ノードへエッジを張ると並列実行
graph.add_edge("start", "task_a")
graph.add_edge("start", "task_b")
graph.add_edge("start", "task_c")

# 全て完了後に次へ
graph.add_edge("task_a", "merge")
graph.add_edge("task_b", "merge")
graph.add_edge("task_c", "merge")

# Airflow の場合
start >> [task_a, task_b, task_c] >> merge
-->

### Map-Reduce パターン

```
{{PATTERN_MAP_REDUCE}}
```

<!-- 使用例:
# LangGraph の場合（Send API）
def map_items(state: MyState) -> list[Send]:
    return [
        Send("process_item", {"item": item, "index": i})
        for i, item in enumerate(state["items"])
    ]

graph.add_conditional_edges("split", map_items)
-->

---

## エラーハンドリングパターン

### ノード内エラーハンドリング

```
{{PATTERN_ERROR_IN_NODE}}
```

<!-- 使用例:
# LangGraph の場合
def safe_node(state: MyState) -> MyState:
    try:
        result = risky_operation(state["input"])
        return {"output": result, "error": None}
    except ValidationError as e:
        return {"error": f"Validation failed: {e}", "status": "failed"}
    except ExternalAPIError as e:
        return {"error": f"API error: {e}", "should_retry": True}
-->

### エラー専用ノードへの分岐

```
{{PATTERN_ERROR_ROUTING}}
```

<!-- 使用例:
# LangGraph の場合
def error_router(state: MyState) -> str:
    if state.get("error"):
        if state.get("should_retry"):
            return "retry_handler"
        return "error_handler"
    return "next_step"

graph.add_conditional_edges(
    "process",
    error_router,
    {
        "next_step": "continue",
        "retry_handler": "retry",
        "error_handler": "notify_error"
    }
)
-->

### 補償トランザクション（ロールバック）

```
{{PATTERN_COMPENSATION}}
```

<!-- 使用例:
def compensation_node(state: MyState) -> MyState:
    """エラー時の補償処理"""
    for action in reversed(state.get("completed_actions", [])):
        try:
            rollback_action(action)
        except Exception as e:
            log.error(f"Rollback failed for {action}: {e}")
    return {"status": "rolled_back"}
-->

---

## リトライパターン

### 指数バックオフリトライ

```
{{PATTERN_RETRY_BACKOFF}}
```

<!-- 使用例:
# LangGraph の場合（ノード内）
import asyncio
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=30)
)
async def call_external_api(params):
    return await api_client.call(params)

# Temporal Activity の場合
@activity.defn
async def my_activity(input: str) -> str:
    # Temporal 側でリトライ設定
    pass

# Activity Options
activity_options = ActivityOptions(
    retry_policy=RetryPolicy(
        maximum_attempts=3,
        initial_interval=timedelta(seconds=2),
        backoff_coefficient=2.0,
        maximum_interval=timedelta(seconds=30),
    )
)
-->

### リトライ回数の状態管理

```
{{PATTERN_RETRY_STATE}}
```

<!-- 使用例:
def retry_aware_node(state: MyState) -> MyState:
    retry_count = state.get("retry_count", 0)

    try:
        result = process(state["input"])
        return {"output": result, "retry_count": 0}
    except RetryableError:
        if retry_count >= 3:
            return {"error": "Max retries exceeded", "status": "failed"}
        return {"retry_count": retry_count + 1, "should_retry": True}
-->

---

## Human-in-the-loop パターン

### 承認待ちパターン

```
{{PATTERN_HITL_APPROVAL}}
```

<!-- 使用例:
# LangGraph + interrupt の場合
def approval_node(state: MyState) -> MyState:
    if not state.get("approved"):
        raise NodeInterrupt("Waiting for approval")
    return state

# Temporal + Signal の場合
@workflow.signal
async def approve_signal(approved: bool):
    self.approved = approved

await workflow.wait_condition(lambda: self.approved is not None)
-->

### フィードバックループ

```
{{PATTERN_HITL_FEEDBACK}}
```

<!-- 使用例:
def feedback_loop(state: MyState) -> str:
    if state.get("feedback"):
        return "revise"
    if state.get("approved"):
        return "continue"
    return "wait_feedback"  # interrupt point
-->

---

## 使用方法

```bash
# パターン一覧を表示
/{{WORKFLOW_FRAMEWORK_LOWER}}-patterns list

# 特定パターンの詳細を表示
/{{WORKFLOW_FRAMEWORK_LOWER}}-patterns show <pattern_name>

# パターンをコードに適用
/{{WORKFLOW_FRAMEWORK_LOWER}}-patterns apply <pattern_name> --target <file>
```

---

## 関連スキル

| スキル | 用途 |
|--------|------|
| `/{{WORKFLOW_FRAMEWORK_LOWER}}-fundamentals` | 基本概念 |
| `/{{WORKFLOW_FRAMEWORK_LOWER}}-multi-agent` | マルチエージェント構成 |
| `/{{WORKFLOW_FRAMEWORK_LOWER}}-persistence` | 状態の永続化 |
| `/workflow-step-impl` | 工程実装ガイド |

---

## 変数一覧

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `{{WORKFLOW_FRAMEWORK}}` | フレームワーク名 | YES |
| `{{WORKFLOW_FRAMEWORK_LOWER}}` | 小文字 | YES |
| `{{PATTERN_CONDITIONAL_SIMPLE}}` | 条件分岐の例 | YES |
| `{{PATTERN_CONDITIONAL_MULTI}}` | 複数条件分岐の例 | YES |
| `{{PATTERN_LOOP_CONDITIONAL}}` | 条件付きループの例 | YES |
| `{{PATTERN_LOOP_ITERATE}}` | 反復処理の例 | YES |
| `{{PATTERN_PARALLEL_NODES}}` | 並列実行の例 | YES |
| `{{PATTERN_MAP_REDUCE}}` | Map-Reduce の例 | NO |
| `{{PATTERN_ERROR_IN_NODE}}` | エラーハンドリングの例 | YES |
| `{{PATTERN_ERROR_ROUTING}}` | エラー分岐の例 | YES |
| `{{PATTERN_COMPENSATION}}` | 補償処理の例 | NO |
| `{{PATTERN_RETRY_BACKOFF}}` | リトライの例 | YES |
| `{{PATTERN_RETRY_STATE}}` | リトライ状態管理の例 | NO |
| `{{PATTERN_HITL_APPROVAL}}` | 承認待ちの例 | NO |
| `{{PATTERN_HITL_FEEDBACK}}` | フィードバックループの例 | NO |
