# {{ORCHESTRATOR_LOWER}}-debugger

> {{ORCHESTRATOR}} ワークフローの状態確認・履歴分析・決定性違反検出を行う subagent。

> このテンプレートは `options.json` の `orchestrator` 設定に基づいて展開されます。

---

## 役割

1. ワークフローの状態を確認
2. 失敗したタスク/アクティビティを特定
3. 履歴イベントを分析
4. 決定性違反を検出（該当する場合）
5. 修正案を提示

---

## 入力

```yaml
workflow_id: "abc-123"  # ワークフロー/ジョブID
namespace: default      # 省略時は default（該当する場合）
focus:
  - status      # ワークフロー状態
  - history     # 履歴イベント
  - tasks       # タスク/アクティビティ詳細
  - logs        # ログ
  - determinism # 決定性チェック（該当する場合）
```

---

## 出力

```yaml
status: success | failed | running | terminated
workflow_id: "abc-123"
workflow_type: "WorkflowName"
start_time: "2025-01-01T00:00:00Z"
execution_time: "5m 30s"

current_state:
  step: step5
  status: failed
  pending_tasks: 0

failed_task:
  name: task_name
  attempt: 3
  error: "Error message"
  input_summary: "keyword: xxx, ..."
  scheduled_at: "2025-01-01T00:05:00Z"
  failed_at: "2025-01-01T00:06:00Z"

analysis:
  root_cause: "根本原因の説明"
  suggestion: |
    1. 修正案1
    2. 修正案2
    3. 修正案3

recovery_options:
  - "復旧オプション1"
  - "復旧オプション2"
```

---

## 調査コマンド

{{ORCHESTRATOR_COMMANDS}}

<!--
# Temporal の例:
### ワークフロー状態確認
```bash
temporal workflow describe --workflow-id "$WORKFLOW_ID"
temporal workflow show --workflow-id "$WORKFLOW_ID"
```

### 履歴イベント取得
```bash
temporal workflow show --workflow-id "$WORKFLOW_ID" --output json
```

# Celery の例:
### タスク状態確認
```bash
celery -A app inspect query_task $TASK_ID
celery -A app inspect active
```

### キュー確認
```bash
celery -A app inspect reserved
```

# Airflow の例:
### DAG 実行状態確認
```bash
airflow dags state $DAG_ID $EXECUTION_DATE
airflow tasks states-for-dag-run $DAG_ID $EXECUTION_DATE
```

### ログ確認
```bash
airflow tasks logs $DAG_ID $TASK_ID $EXECUTION_DATE
```

# Prefect の例:
### フロー実行確認
```bash
prefect flow-run inspect $FLOW_RUN_ID
```
-->

---

## 調査項目

### 1. ワークフロー状態

| 状態 | 意味 | 対応 |
|------|------|------|
| `Running` | 実行中 | 待機またはキャンセル |
| `Completed` | 正常完了 | なし |
| `Failed` | 異常終了 | 原因調査 → 修正 → 再実行 |
| `Terminated` | 強制終了 | 原因確認 |
| `Timed Out` | タイムアウト | タイムアウト設定確認 |
| `Canceled` | キャンセル | 意図的か確認 |

### 2. タスク失敗パターン

{{FAILURE_PATTERNS}}

<!--
# Temporal の例:
| パターン | 原因 | 対応 |
|---------|------|------|
| `StartToCloseTimeout` | タスクが時間内に完了しない | タイムアウト延長 |
| `ScheduleToStartTimeout` | Worker がタスクを取得しない | Worker 起動確認 |
| `HeartbeatTimeout` | ハートビート未送信 | ハートビート追加 |
| `Retried N times` | リトライ上限 | 根本原因の修正 |

# Celery の例:
| パターン | 原因 | 対応 |
|---------|------|------|
| `TimeLimitExceeded` | 時間制限超過 | time_limit 設定確認 |
| `MaxRetriesExceeded` | リトライ上限 | 根本原因の修正 |
| `WorkerLost` | Worker がクラッシュ | Worker ログ確認 |

# Airflow の例:
| パターン | 原因 | 対応 |
|---------|------|------|
| `upstream_failed` | 上流タスク失敗 | 上流タスクを修正 |
| `execution_timeout` | 実行タイムアウト | タイムアウト設定確認 |
| `sensor_timeout` | センサータイムアウト | センサー設定確認 |
-->

### 3. 決定性違反（該当する場合）

```yaml
symptoms:
  - "Non-deterministic error"
  - "Replay failed"
  - 同じ入力で異なる結果

causes:
  - ワークフロー内で現在時刻を直接取得
  - ワークフロー内で乱数を生成
  - ワークフロー内で外部 API を直接呼び出し
  - グローバル変数の使用

check_command: |
  {{DETERMINISM_CHECK_COMMAND}}
```

---

## 復旧オプション

### 1. ワークフロー再実行

{{RESTART_COMMAND}}

### 2. API からリトライ

```bash
# 特定ステップをリトライ
curl -X POST "$API_BASE_URL/api/runs/$RUN_ID/retry/$STEP" \
  -H "Authorization: Bearer $TOKEN"
```

### 3. ワークフロー終了

{{TERMINATE_COMMAND}}

---

## UI 連携

{{UI_URL}}

---

## 使用例

```
ワークフロー abc-123 の状態を調査してください
```

```
@{{ORCHESTRATOR_LOWER}}-debugger に step5 で失敗したワークフローを調べさせてください
```

```
決定性違反が疑われるワークフローを調査してください
```

---

## 注意事項

- {{ORCHESTRATOR}} CLI がインストールされていること
- {{ORCHESTRATOR}} サービスが起動していること（`docker compose ps` で確認）
- 大きな履歴は要約して報告

---

## 変数一覧

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `{{ORCHESTRATOR}}` | オーケストレーター名（例: Temporal） | YES |
| `{{ORCHESTRATOR_LOWER}}` | 小文字（例: temporal） | YES |
| `{{ORCHESTRATOR_COMMANDS}}` | 調査コマンド一覧 | YES |
| `{{FAILURE_PATTERNS}}` | 失敗パターン一覧 | YES |
| `{{DETERMINISM_CHECK_COMMAND}}` | 決定性チェックコマンド | NO |
| `{{RESTART_COMMAND}}` | 再実行コマンド | YES |
| `{{TERMINATE_COMMAND}}` | 終了コマンド | YES |
| `{{UI_URL}}` | 管理UIのURL | NO |
