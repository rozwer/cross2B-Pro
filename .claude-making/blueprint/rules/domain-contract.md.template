---
description: ドメイン契約（ワークフロー・承認・成果物）
---

# ドメイン契約

> ワークフローの工程、承認ポイント、成果物の規約を定義。

---

## 1. ワークフロー工程

{{WORKFLOW_STEPS}}

<!-- 使用例:
### 工程一覧

| 工程 | 名称       | 説明                     | 依存工程 |
| ---- | ---------- | ------------------------ | -------- |
| 1    | 入力       | ユーザー入力の受付       | -        |
| 2    | 検証       | 入力データの検証         | 1        |
| 3A   | 処理A      | 並列処理A                | 2        |
| 3B   | 処理B      | 並列処理B                | 2        |
| 3C   | 処理C      | 並列処理C                | 2        |
| 4    | 統合       | 並列処理の結果を統合     | 3A,3B,3C |
| 5    | 出力       | 最終出力の生成           | 4        |

### 工程フロー図

```
[1: 入力] → [2: 検証] → ┬─ [3A: 処理A] ─┬
                        ├─ [3B: 処理B] ─┼→ [4: 統合] → [5: 出力]
                        └─ [3C: 処理C] ─┘
```

### 工程詳細

#### 工程1: 入力

- **入力**: ユーザーからのリクエスト
- **処理**: 入力データの受付と初期化
- **出力**: 正規化された入力データ
- **エラー**: 入力形式エラー

#### 工程2: 検証

- **入力**: 工程1の出力
- **処理**: バリデーション、重複チェック
- **出力**: 検証済みデータ
- **エラー**: バリデーションエラー
-->

---

## 2. 承認ポイント（Human-in-the-loop）

{{APPROVAL_POINTS}}

<!-- 使用例:
### 承認が必要な工程

| 工程 | 承認タイプ | 承認者     | タイムアウト |
| ---- | ---------- | ---------- | ------------ |
| 3    | 並列完了後 | 管理者     | 24時間       |
| 5    | 最終出力前 | オーナー   | 48時間       |

### 承認フロー

```
[工程3完了] → [承認待ち] → ┬─ [承認] → [工程4へ]
                           ├─ [却下] → [工程2へ戻る]
                           └─ [タイムアウト] → [自動キャンセル]
```

### 承認時の確認事項

1. **データ品質**: 出力データが期待通りか
2. **ビジネスルール**: ドメインルールに準拠しているか
3. **エラーなし**: 警告やエラーがないか

### 却下時の処理

- 却下理由を記録（必須）
- 関連工程を再実行可能状態に
- 通知を送信
-->

### 承認アクション

| アクション | 説明 | 次の状態 |
|-----------|------|----------|
| `approve` | 承認して次工程へ | 次工程の実行 |
| `reject` | 却下して差し戻し | 指定工程へ戻る |
| `retry` | 同一工程を再実行 | 工程の再実行 |
| `cancel` | ワークフローを中止 | 終了 |

### 監査ログ

承認/却下/再実行/キャンセルは必ず記録:

```yaml
audit_entry:
  action: approve | reject | retry | cancel
  actor: ユーザーID
  timestamp: ISO8601
  workflow_id: ワークフローID
  step: 工程名
  reason: 理由（却下時は必須）
```

---

## 3. 成果物（Artifacts）

{{ARTIFACT_RULES}}

<!-- 使用例:
### 成果物一覧

| 工程 | 成果物名     | 形式 | 保存先         |
| ---- | ------------ | ---- | -------------- |
| 1    | input.json   | JSON | storage/{id}/1/|
| 3A   | result_a.json| JSON | storage/{id}/3a/|
| 3B   | result_b.json| JSON | storage/{id}/3b/|
| 3C   | result_c.json| JSON | storage/{id}/3c/|
| 5    | output.html  | HTML | storage/{id}/5/|

### 成果物フィールド

| フィールド      | 説明                           |
| --------------- | ------------------------------ |
| `output_path`   | ストレージ上のパス             |
| `output_digest` | SHA256ハッシュ                 |
| `summary`       | 概要（UI/ログ用）              |
| `metrics`       | メトリクス（サイズ/件数など）  |
| `created_at`    | 作成日時                       |
-->

### ストレージパス規約

```
storage/{tenant_id}/{workflow_id}/{step}/output.json
storage/{tenant_id}/{workflow_id}/{step}/artifacts/
```

### 成果物の参照

DB/状態には参照のみを保存:

```python
step_result = {
    "output_path": "storage/tenant1/wf123/step3/output.json",
    "output_digest": "sha256:abc123...",
    "summary": "処理完了: 100件",
    "metrics": {
        "count": 100,
        "size_bytes": 12345,
    }
}
```

### 禁止事項

```
- 大きなデータを DB/状態に直接保存しない
- 成果物は必ず storage に保存し、参照のみを持つ
- 成果物の直接編集は禁止（新しいバージョンを作成）
```

---

## 4. 工程実行ルール

### 冪等性（必須）

```python
# 同一入力 → 同一出力
def execute_step(input_data):
    cache_key = hash(input_data)
    if cached := storage.get(cache_key):
        return cached  # 再計算しない

    result = process(input_data)
    storage.put(cache_key, result)
    return result
```

### リトライポリシー

```yaml
retry_policy:
  max_attempts: 3
  initial_interval: 1s
  backoff_coefficient: 2.0
  max_interval: 30s
  non_retryable_errors:
    - ValidationError
    - AuthenticationError
```

### タイムアウト

| 工程タイプ | タイムアウト |
|-----------|------------|
| 軽量処理 | 30秒 |
| 通常処理 | 5分 |
| 重量処理 | 30分 |
| 承認待ち | 24-48時間 |

---

## 5. 状態遷移

### ワークフロー状態

| 状態 | 説明 |
|------|------|
| `pending` | 開始待ち |
| `running` | 実行中 |
| `waiting_approval` | 承認待ち |
| `completed` | 完了 |
| `failed` | 失敗 |
| `cancelled` | キャンセル |

### 工程状態

| 状態 | 説明 |
|------|------|
| `pending` | 未開始 |
| `running` | 実行中 |
| `completed` | 完了 |
| `failed` | 失敗 |
| `skipped` | スキップ |

### 状態遷移図

```
[pending] → [running] → [waiting_approval] → [running] → [completed]
                ↓              ↓
            [failed]      [cancelled]
```

---

## 6. エラーハンドリング

### エラータイプ

| タイプ | 説明 | リトライ |
|--------|------|---------|
| `retryable` | 一時的エラー | 可 |
| `non_retryable` | 永続的エラー | 不可 |
| `approval_required` | 人間の判断が必要 | - |

### エラー時の処理

```python
try:
    result = execute_step(input_data)
except RetryableError as e:
    # リトライ対象
    log.warning(f"Retryable error: {e}")
    raise  # Temporal がリトライ
except NonRetryableError as e:
    # リトライ不可
    log.error(f"Non-retryable error: {e}")
    mark_failed(workflow_id, step, str(e))
    raise
```

---

## 変数一覧

| 変数名              | 説明                       | 必須 |
| ------------------- | -------------------------- | ---- |
| `{{WORKFLOW_STEPS}}`| ワークフロー工程の定義     | YES  |
| `{{APPROVAL_POINTS}}`| 承認ポイントの定義        | YES  |
| `{{ARTIFACT_RULES}}`| 成果物の規約              | YES  |
