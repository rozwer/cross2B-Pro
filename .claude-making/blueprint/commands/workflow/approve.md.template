---
description: Human-in-the-loop の承認待ち工程を承認/却下
allowed-tools: Bash, Task, Read, Glob, Grep
---

# /workflow:approve

> {{ORCHESTRATOR}} ワークフローの承認待ち工程を承認または却下する（Human-in-the-loop）

---

## 実行

{{EXECUTION_STEPS}}

<!-- 使用例:
1. 引数を解析
   - 必須: run_id（実行 ID）
   - オプション: --reject, --reason, --step

2. 現在の状態を確認
   - 承認待ち状態であることを確認
   - 承認対象の工程と成果物を取得
   - プレビュー表示

3. 承認/却下を実行
   - API または Temporal signal 経由
   - 監査ログに記録
   - ワークフローを再開

4. 結果を出力
   - 承認/却下結果
   - 次の工程の状態
-->

---

## 使用例

```bash
# 承認
/workflow:approve <run_id>

# 却下（理由必須）
/workflow:approve <run_id> --reject --reason "タイトルが不適切"

# 特定の工程を指定
/workflow:approve <run_id> --step step3

# プレビューのみ（承認せず確認）
/workflow:approve <run_id> --preview

# 強制承認（確認スキップ）
/workflow:approve <run_id> --force
```

---

## 引数

| 引数 | 説明 | 必須 | デフォルト |
|------|------|------|-----------|
| `run_id` | 実行 ID | YES | - |
| `--reject` | 却下する | NO | false（承認） |
| `--reason` | 理由（却下時は必須） | NO | - |
| `--step` | 対象工程 | NO | 現在の待機工程 |
| `--preview` | プレビューのみ | NO | false |
| `--force` | 確認スキップ | NO | false |

---

## 承認フロー

```
┌─────────────────────────────────────────────────────────┐
│                     承認フロー                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 工程完了 → 承認待ち状態                              │
│       ↓                                                 │
│  2. /workflow:run で状態確認                            │
│       ↓                                                 │
│  3. /workflow:artifacts で成果物確認                    │
│       ↓                                                 │
│  4. /workflow:approve で承認 or 却下                    │
│       ↓                                                 │
│  5a. 承認 → 次の工程へ進行                              │
│  5b. 却下 → 修正 → 再実行 or 終了                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 出力

### 承認前（プレビュー）

```
[workflow:approve プレビュー]

Run ID: {{run_id}}
ワークフロー: {{workflow_type}}
承認対象工程: Step 3（構成案/詳細化/タイトル案）

[成果物サマリ]
┌─────────┬────────────────────────────────────────┐
│ Step 3A │ 構成案: 5セクション、約5000文字予定     │
│ Step 3B │ 詳細化: 各セクション800-1200文字       │
│ Step 3C │ タイトル案: 3案生成                    │
└─────────┴────────────────────────────────────────┘

[プレビュー]
## タイトル案
1. SEO対策の完全ガイド2025年版
2. 検索順位を上げる実践的SEO戦略
3. 初心者でもわかるSEO基礎と応用

## 構成案
1. SEOとは何か
2. キーワード選定
3. コンテンツ最適化
...

[アクション]
- 承認する: /workflow:approve {{run_id}}
- 却下する: /workflow:approve {{run_id}} --reject --reason "理由"
```

### 承認成功時

```
[workflow:approve 完了]

Run ID: {{run_id}}
アクション: 承認
承認工程: Step 3
承認者: user@example.com
承認時刻: 2025-01-01 12:30:00

[結果]
ステータス: running（次の工程へ進行）
次の工程: Step 4（本文生成）

[監査ログ]
ID: audit-12345
記録: 承認完了

[次のステップ]
- /workflow:run {{run_id}} で進捗確認
```

### 却下成功時

```
[workflow:approve 完了]

Run ID: {{run_id}}
アクション: 却下
却下工程: Step 3
却下理由: タイトルが不適切
却下者: user@example.com
却下時刻: 2025-01-01 12:30:00

[結果]
ステータス: rejected
ワークフロー状態: 停止

[監査ログ]
ID: audit-12346
記録: 却下完了

[次のステップ]
- 修正して /workflow:new で再実行
- または /workflow:run {{run_id}} --retry step3 で工程再実行
```

### 失敗時

```
[workflow:approve 失敗]

Run ID: {{run_id}}
エラー: Workflow is not in pending approval state

[現在の状態]
ステータス: running（実行中）

[推奨アクション]
1. /workflow:run {{run_id}} で現在の状態を確認
2. 承認待ち状態になるまで待機
```

---

## 実装詳細

### API 経由

```bash
{{API_APPROVE_COMMAND}}
```

<!-- 使用例（Temporal）:
```bash
# 承認
curl -X POST http://localhost:8000/api/runs/{{run_id}}/approve \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN"

# 却下
curl -X POST http://localhost:8000/api/runs/{{run_id}}/reject \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"reason": "タイトルが不適切"}'
```
-->

### Temporal Signal 経由

```bash
{{SIGNAL_COMMAND}}
```

<!-- 使用例:
```bash
# Temporal CLI で signal 送信
temporal workflow signal \
  --workflow-id {{run_id}} \
  --name approve \
  --input '{"approved": true}'
```
-->

---

## 監査ログ

承認/却下は以下の情報を監査ログに記録:

| フィールド | 説明 |
|-----------|------|
| `actor` | 承認者のユーザー ID |
| `tenant_id` | テナント ID |
| `run_id` | ワークフロー実行 ID |
| `step` | 対象工程 |
| `action` | approve / reject |
| `reason` | 理由（却下時） |
| `timestamp` | 実行時刻 |

---

## 前提条件

- {{ORCHESTRATOR}} が稼働中
- ワークフローが承認待ち状態
- 承認権限を持つユーザー

---

## 関連コマンド

| コマンド | 説明 |
|----------|------|
| `/workflow:run` | 実行状態の確認 |
| `/workflow:artifacts` | 成果物の取得（承認前確認用） |
| `/workflow:new` | 新規実行開始（却下後の再実行） |

---

## 手動実行

コマンドを使わずに手動で実行する場合:

```bash
# {{ORCHESTRATOR}} CLI（Signal）
{{MANUAL_SIGNAL_COMMAND}}

# API 直接呼び出し
{{MANUAL_API_APPROVE_COMMAND}}
```

---

## 変数一覧

| 変数名 | 説明 | 必須 |
| ------ | ---- | ---- |
| `{{ORCHESTRATOR}}` | オーケストレーター名 | YES |
| `{{WORKFLOW_FRAMEWORK}}` | ワークフローフレームワーク | YES |
| `{{EXECUTION_STEPS}}` | 実行ステップ | YES |
| `{{API_APPROVE_COMMAND}}` | API 経由の承認コマンド | YES |
| `{{SIGNAL_COMMAND}}` | Signal 送信コマンド | YES |
| `{{MANUAL_SIGNAL_COMMAND}}` | 手動 Signal コマンド | YES |
| `{{MANUAL_API_APPROVE_COMMAND}}` | 手動 API コマンド | YES |
