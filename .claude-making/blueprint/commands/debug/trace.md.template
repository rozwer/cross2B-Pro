---
description: {{ORCHESTRATOR}} 実行トレースの確認とボトルネック分析
---

# {{ORCHESTRATOR}} Trace

> このテンプレートは `options.json` の `orchestrator` 設定に基づいて展開されます。

## 目的

- ワークフロー実行の詳細なトレースを確認する
- 各タスク/アクティビティの実行時間を分析する
- ボトルネックを特定する
- 障害の根本原因を調査する

---

## 前提条件

- {{ORCHESTRATOR}} サービスが起動していること
- {{ORCHESTRATOR}} CLI がインストールされていること
- 対象ワークフローの ID がわかっていること

---

## 基本コマンド

### 1. ワークフロー状態の確認

```bash
{{STATUS_COMMAND}}
```

### 2. 実行トレースの取得

```bash
{{TRACE_COMMAND}}
```

### 3. 特定タスクの詳細確認

```bash
{{TASK_DETAIL_COMMAND}}
```

---

## 分析項目

### 1. 実行時間の分析

```bash
{{TIMING_ANALYSIS_COMMAND}}
```

出力例：
```
Task/Activity          Duration    Status
─────────────────────────────────────────
step1_initialize       0.5s        completed
step2_fetch_data       2.3s        completed
step3_process          15.2s       completed  ← ボトルネック
step4_validate         0.8s        completed
step5_output           1.1s        failed
```

### 2. 待機時間の分析

```bash
{{WAIT_ANALYSIS_COMMAND}}
```

確認項目：
- キュー待ち時間
- Worker の取得待ち
- 外部依存の待機

### 3. リトライ履歴

```bash
{{RETRY_HISTORY_COMMAND}}
```

確認項目：
- リトライ回数
- リトライ間隔
- 各試行のエラー内容

---

## ボトルネック分析

### パフォーマンス問題の特定

| 症状 | 原因 | 対策 |
|------|------|------|
| 特定タスクが遅い | 処理が重い | 並列化、キャッシュ導入 |
| キュー待ちが長い | Worker 不足 | Worker 増設 |
| リトライが多い | 不安定な依存先 | リトライ設定調整、サーキットブレーカー |
| 全体的に遅い | リソース不足 | スケールアップ/アウト |

### 分析手順

```
1. 全体の実行時間を確認
   ├─ 期待値と比較
   └─ 異常に長い場合は詳細分析へ

2. タスク別の実行時間を確認
   ├─ 最も時間がかかっているタスクを特定
   └─ 待機時間 vs 実行時間を区別

3. 失敗/リトライを確認
   ├─ リトライ回数が多いタスクを特定
   └─ エラー内容を分析

4. 依存関係を確認
   ├─ 並列化可能な処理がないか
   └─ 不要な依存がないか
```

---

## 出力形式

### JSON 形式

```bash
{{JSON_OUTPUT_COMMAND}}
```

### 可視化（該当する場合）

```bash
{{VISUALIZATION_COMMAND}}
```

---

## イベント種別

{{EVENT_TYPES}}

<!--
# Temporal の例:
| イベント | 意味 |
|---------|------|
| WorkflowExecutionStarted | ワークフロー開始 |
| WorkflowExecutionCompleted | ワークフロー完了 |
| ActivityTaskScheduled | アクティビティスケジュール |
| ActivityTaskStarted | アクティビティ開始 |
| ActivityTaskCompleted | アクティビティ完了 |
| ActivityTaskFailed | アクティビティ失敗 |

# Celery の例:
| イベント | 意味 |
|---------|------|
| task-sent | タスク送信 |
| task-received | タスク受信 |
| task-started | タスク開始 |
| task-succeeded | タスク成功 |
| task-failed | タスク失敗 |
| task-retried | タスクリトライ |

# Airflow の例:
| イベント | 意味 |
|---------|------|
| running | 実行中 |
| success | 成功 |
| failed | 失敗 |
| upstream_failed | 上流失敗 |
| skipped | スキップ |
-->

---

## UI での確認

{{UI_TRACE_URL}}

<!--
# Temporal の例:
ブラウザで確認:
http://localhost:8080/namespaces/default/workflows/$WORKFLOW_ID

# Celery + Flower の例:
ブラウザで確認:
http://localhost:5555/task/$TASK_ID

# Airflow の例:
ブラウザで確認:
http://localhost:8080/dags/$DAG_ID/grid

# Prefect の例:
ブラウザで確認:
http://localhost:4200/flow-runs/$FLOW_RUN_ID
-->

---

## トラブルシューティング

| 症状 | 原因 | 解決策 |
|------|------|--------|
| トレースが取得できない | ワークフローが存在しない | ID を確認 |
| 情報が不完全 | ログレベルが低い | ログ設定を確認 |
| UI にアクセスできない | サービス未起動 | `docker compose ps` で確認 |

---

## 関連コマンド

- `/debug:replay` - ワークフローの再実行
- `@{{ORCHESTRATOR_LOWER}}-debugger` - 詳細なデバッグ分析

---

## 変数一覧

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `{{ORCHESTRATOR}}` | オーケストレーター名 | YES |
| `{{STATUS_COMMAND}}` | 状態確認コマンド | YES |
| `{{TRACE_COMMAND}}` | トレース取得コマンド | YES |
| `{{TASK_DETAIL_COMMAND}}` | タスク詳細確認コマンド | YES |
| `{{TIMING_ANALYSIS_COMMAND}}` | 実行時間分析コマンド | YES |
| `{{WAIT_ANALYSIS_COMMAND}}` | 待機時間分析コマンド | NO |
| `{{RETRY_HISTORY_COMMAND}}` | リトライ履歴コマンド | YES |
| `{{JSON_OUTPUT_COMMAND}}` | JSON出力コマンド | NO |
| `{{VISUALIZATION_COMMAND}}` | 可視化コマンド | NO |
| `{{EVENT_TYPES}}` | イベント種別一覧 | YES |
| `{{UI_TRACE_URL}}` | UI確認URL | NO |
