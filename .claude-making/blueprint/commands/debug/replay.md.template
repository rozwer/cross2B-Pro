---
description: {{ORCHESTRATOR}} リプレイ（決定性違反/履歴起因バグの切り分け）
---

# {{ORCHESTRATOR}} Replay

> このテンプレートは `options.json` の `orchestrator` 設定に基づいて展開されます。

## 目的

- ワークフローの決定性違反や、履歴に依存する不具合を安全に再現する
- 特定のポイントからワークフローを再開する
- 過去の実行履歴を使用してローカルで問題を再現する

---

## 前提条件

- {{ORCHESTRATOR}} サービスが起動していること
- {{ORCHESTRATOR}} CLI がインストールされていること
- 対象ワークフローの ID がわかっていること

---

## 基本コマンド

### 1. 履歴の取得

```bash
{{GET_HISTORY_COMMAND}}
```

### 2. リプレイの実行

```bash
{{REPLAY_COMMAND}}
```

### 3. 特定ポイントからの再開

```bash
{{RESUME_COMMAND}}
```

---

## 使用シナリオ

### シナリオ1: 決定性違反の検出

ワークフローが「Non-deterministic error」で失敗した場合：

```bash
# 1. 履歴を取得
{{GET_HISTORY_COMMAND}}

# 2. リプレイで再現
{{REPLAY_COMMAND}}

# 3. 最初の差分を特定
# - 非決定な分岐
# - 時刻依存
# - 乱数使用
# - 外部 I/O 直接呼び出し
```

### シナリオ2: 失敗した実行の再開

タスクが失敗した後、修正を適用して再開する場合：

```bash
# 1. 失敗したタスクを特定
{{INSPECT_FAILED_COMMAND}}

# 2. コードを修正

# 3. 特定ポイントから再開
{{RESUME_COMMAND}}
```

### シナリオ3: デバッグ目的の再実行

本番で発生した問題をローカルで再現する場合：

```bash
# 1. 本番環境から履歴をエクスポート
{{EXPORT_HISTORY_COMMAND}}

# 2. ローカル環境でリプレイ
{{LOCAL_REPLAY_COMMAND}}
```

---

## よくある決定性違反

| 違反パターン | 原因 | 修正方法 |
|-------------|------|----------|
| 時刻依存 | ワークフロー内で `datetime.now()` 等を使用 | オーケストレーター提供の時刻関数を使用 |
| 乱数 | ワークフロー内で `random.random()` 等を使用 | オーケストレーター提供の乱数関数を使用 |
| 外部I/O | ワークフロー内で直接 API 呼び出し | タスク/アクティビティに移動 |
| グローバル状態 | グローバル変数の参照/更新 | ワークフロー状態として管理 |
| 非決定的ライブラリ | UUID生成など | オーケストレーター提供の関数を使用 |

---

## {{ORCHESTRATOR}} 固有の注意点

{{ORCHESTRATOR_NOTES}}

<!--
# Temporal の例:
- `workflow.now()` を使用して時刻を取得
- `workflow.random()` を使用して乱数を生成
- Side Effect API を使用して非決定的な処理をラップ
- Replay テストを定期的に実行

# Celery の例:
- Celery はリプレイ機能を持たないため、タスクの冪等性設計が重要
- 失敗したタスクは再キューイングで対応
- 結果のキャッシュを活用

# Airflow の例:
- `execution_date` を基準に再実行
- タスクの冪等性を確保
- `catchup=False` の設定を確認

# Prefect の例:
- フロー実行の再開は `resume` パラメータで制御
- `idempotency_key` を活用
-->

---

## トラブルシューティング

| 症状 | 原因 | 解決策 |
|------|------|--------|
| リプレイが失敗する | コード変更後に履歴と不整合 | 新しいワークフローとして再実行 |
| 履歴が取得できない | 保持期間が過ぎた | 保持設定を確認 |
| 再開後も同じエラー | 根本原因が未修正 | ログを確認して原因を特定 |

---

## 関連コマンド

- `/debug:trace` - 実行トレースの確認
- `@{{ORCHESTRATOR_LOWER}}-debugger` - 詳細なデバッグ分析

---

## 変数一覧

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `{{ORCHESTRATOR}}` | オーケストレーター名 | YES |
| `{{GET_HISTORY_COMMAND}}` | 履歴取得コマンド | YES |
| `{{REPLAY_COMMAND}}` | リプレイコマンド | YES |
| `{{RESUME_COMMAND}}` | 再開コマンド | YES |
| `{{INSPECT_FAILED_COMMAND}}` | 失敗タスク確認コマンド | YES |
| `{{EXPORT_HISTORY_COMMAND}}` | 履歴エクスポートコマンド | NO |
| `{{LOCAL_REPLAY_COMMAND}}` | ローカルリプレイコマンド | NO |
| `{{ORCHESTRATOR_NOTES}}` | オーケストレーター固有の注意点 | YES |
