# プロンプト改善ガイド

> **目的**: このドキュメントを読んだClaude/LLMが、SEO記事生成プロンプトの改善を行えるようにする
> **最終更新**: 2026-02-25
> **プロンプトファイル**: `apps/api/prompts/packs/default.json`

---

## 1. システム概要

### ワークフロー

SEO記事を12ステップで自動生成するシステム。各ステップに専用プロンプトがある。

```
step0  キーワード分析 → 業界カテゴリ・ペルソナ・4本柱設計
step1  SERP分析 → 競合記事の見出し・文字数を収集（承認待ち）
step1_5 関連KW抽出
step2  サイトマップ
step3a KW分類 → キーワードをカテゴリ分け
step3b KW拡張 → ロングテール・共起語生成
step3c 競合分析 → 競合記事の構造分析（承認待ち）
step3_5 人間味生成 → 感情フック・体験エピソード
step4  骨格作成 → H2/H3見出し構造
step5  一次情報収集 → Web検索で統計データ・権威ソースを収集（非LLM）
step6  本文生成指示 → 詳細なセクション設計
step6_5 統合パッケージ → 全データを1パッケージに統合
step7a ドラフト生成 → 初稿（最重要ステップ）
step7b リライト → 文体・readability改善
step8  ファクトチェック → claims抽出→検証→FAQ生成
step9  最終編集 → CTA挿入・校正
step10 4記事生成 → メイン・初心者・実践・まとめの4バリエーション
step12 WordPress HTML → Gutenbergブロック形式に変換（非LLM）
```

### プロンプトの構造

`default.json` の各ステップは以下の形式:

```json
{
  "step7a": {
    "step": "step7a",
    "version": "3.2",
    "content": "あなたは工程7A「初稿作成」の専門家です。...",
    "variables": ["keyword", "integration_package", "human_touch_elements", "primary_sources"]
  }
}
```

- `content`: プロンプト本文。`{{variable}}` でランタイム変数を埋め込む
- `variables`: そのステップで使用可能な変数リスト
- ステップ間のデータはMinIOに保存され、後続ステップが読み込む

---

## 2. 現在の品質水準

### 最新評価結果（2026-02-25、gemini-2.5-pro）

| 指標 | 現状 | 目標 | ギャップ |
|------|------|------|---------|
| jReadability | 2.97 | 3.0+ | -0.03（ほぼ達成） |
| 文字数（step9） | 12,696 | 10,000+ | 達成 |
| 統計データ数 | 46 | 30+ | 達成 |
| CTA指標 | 14 | 10+ | 達成 |
| **脚注参照数** | **5** | **8+** | **-3（未達）** |
| **権威ソース引用** | **1種** | **3種+** | **-2（未達）** |
| **H2数** | **34** | **40+** | **-6（未達）** |
| step10脚注維持 | 0 | step9と同数 | 全消失 |

### 手動記事との比較（営業 採用 難しい）

| 項目 | 手動記事 | 生成記事 |
|------|---------|---------|
| 文字数 | 11,036 | 12,696 |
| 脚注 | 11件（URL付き） | 5件（URL不完全） |
| 権威ソース | 厚労省・帝国DB・マイナビ | 帝国DB |
| CTA | 11指標 | 14指標 |
| 固有サービス名 | Indeed PLUS, doda等 | 一般論寄り |

---

## 3. 改善が必要なステップと具体的指示

### 3.1 step7a（ドラフト生成）— 最重要

**ファイル内の位置**: `default.json` → `prompts.step7a.content`
**文字数**: 約10,000文字（最大のプロンプト）
**入力変数**: keyword, integration_package, human_touch_elements, primary_sources

**現在うまくいっている点**:
- 3フェーズ構成（不安喚起→理解納得→行動決定）
- AIO/LLMO最適化（冒頭結論ブロック）
- 共起語カバレッジ80%目標
- readability制約（18語/35文字）

**改善が必要な点**:

1. **脚注の参考文献リスト**
   - 現状: `<sup id="ref1">[1]</sup>` で番号を振るが、記事末尾の参考文献リストが不完全
   - 改善: 以下を `content` に追加

   ```
   ## 参考文献リストの必須要件

   記事末尾に以下の形式で参考文献リストを配置すること:

   ---
   **参考文献**
   [1] 厚生労働省「一般職業紹介状況（職業安定業務統計）」https://www.mhlw.go.jp/...
   [2] 帝国データバンク「人手不足に対する企業の動向調査」https://www.tdb.co.jp/...

   - 公的機関は正式名称+調査名+URL
   - 本文中に`<sup>[N]</sup>`があれば、対応する[N]が参考文献リストに必ず存在すること
   - URLが不明な場合は「○○年○月公表」等の時期情報で代替
   ```

2. **権威ソースの複数引用**
   - 現状: 1種類のソースのみ言及する傾向
   - 改善: 以下の指示を追加

   ```
   ## 権威ソース引用ルール

   本文中に最低3つの異なる権威ソースを引用すること:
   - 政府統計（厚生労働省、国土交通省、中小企業庁等）
   - 業界調査（帝国データバンク、リクルートワークス研究所、マイナビ等）
   - 学術・専門機関（大学研究所、業界団体等）

   各ソースは脚注番号付きで引用し、参考文献リストに含めること。
   ```

### 3.2 step4（骨格作成）

**改善が必要な点**: H2数が少ない（34 vs 元記事47）

```
改善指示（step4.contentに追加）:

## 見出し数の目標

- H2: 最低40個を目標とする
- 各H2は100-300文字程度のコンパクトなセクション
- H2にはターゲットキーワードまたは関連語を含めること
- 競合記事の見出し数: {{competitor_heading_count}} を参考に、同等以上を目指す
```

### 3.3 step10（4記事生成）

**改善が必要な点**: step9にある脚注がstep10で全消失する

```
改善指示（step10.contentに追加）:

## 脚注の維持

元記事（step9出力）に含まれる脚注（<sup>[N]</sup>）と参考文献リストは、
各バリエーション記事でも可能な限り維持すること。

- メイン記事: 元記事の脚注を全て含める
- 他バリエーション: 該当する脚注を選択的に含める
- 参考文献リストは各記事の末尾に配置
```

### 3.4 step9（最終編集）

**改善が必要な点**: CTA文言が一般的

```
改善指示（step9.contentに追加）:

## CTA具体化ルール

CTAは以下の要素を含む具体的な文言にすること:
- 具体的なサービス名またはアクション（「採用コンサルティング」「無料診断」等）
- 数値的な訴求（「3分で完了」「最短翌日対応」等）
- 限定性（「先着30社」「今月末まで」等）

避けるべき: 「お気軽にお問い合わせください」のような一般的なCTA
```

---

## 4. プロンプト編集時の注意事項

### やってはいけないこと

1. **変数名の変更**: `{{keyword}}` 等はコードとの連携があり、変更するとエラーになる
2. **JSON構造の破壊**: content内にエスケープなしの`"`や改行があるとJSONパースエラー
3. **readability制約の緩和**: 18語/35文字制約はjReadability 2.97達成の核心。緩めると1.66まで劣化する実測データあり
4. **3フェーズ構成の削除**: 行動経済学フレームワークはCTA配置の基盤

### 編集手順

1. `apps/api/prompts/packs/default.json` を直接編集
2. 該当ステップだけを単体テスト（下記参照）
   - 単体テストはDocker外のPythonスクリプトで実行するため、コンテナ再起動は不要
   - 編集したファイルがそのまま `PromptPackLoader` に読み込まれる
3. 品質確認してOKなら、通しテスト前にworkerを再起動: `docker compose restart worker`

**`--build`は不要**。`default.json`はボリュームマウント（`./apps:/app/apps:ro`）でコンテナ内に反映済み。再起動の目的はworkerプロセス内の**プロンプトキャッシュ（インメモリLRU）をクリア**すること。

**init-db再実行は不要**。プロンプト変更はDB非依存（MinIO JSON保存）。

### テスト実行方法（ステップ単体テスト — 推奨）

**全ステップを通しで実行すると$1.41・30分以上かかる。** プロンプト改善時は、改善対象のステップだけをGemini直接呼び出しでテストすると効率的。

過去runのMinIO成果物を入力として再利用し、改善したプロンプトでGeminiを呼び出す:

```bash
# プロジェクトルートで実行
set -a && source .env && set +a && uv run python3 <<'SCRIPT'
import asyncio, json

async def test_step():
    # ---- 1. プロンプトを読み込む ----
    from apps.api.prompts.loader import PromptPackLoader
    loader = PromptPackLoader()
    pack = loader.load("default")

    # 改善対象のステップ（例: step7a）
    STEP = "step7a"
    template = pack.get_prompt(STEP)

    # ---- 2. MinIOから前ステップの出力を取得 ----
    # 既存runの成果物パスを使用（MinIO UIでも確認可能: http://localhost:9001）
    import boto3
    s3 = boto3.client("s3",
        endpoint_url="http://localhost:9000",
        aws_access_key_id="minioadmin",
        aws_secret_access_key="minioadmin",
    )
    BUCKET = "seo-artifacts"
    RUN_ID = "aee4e514-270f-4d1b-b3d3-a50c0c16f970"  # 過去の成功run
    TENANT = "dev-tenant-001"

    def load_step(step):
        key = f"storage/{TENANT}/{RUN_ID}/{step}/output.json"
        obj = s3.get_object(Bucket=BUCKET, Key=key)
        return json.loads(obj["Body"].read())

    # step7aに必要な入力を過去runから取得
    step6_5 = load_step("step6_5")
    step3_5 = load_step("step3_5")
    step5   = load_step("step5")

    # ---- 3. プロンプトをレンダリング ----
    integration_package = step6_5.get("integration_package", "")
    human_touch = json.dumps(step3_5.get("human_touch_elements", {}), ensure_ascii=False)
    primary_sources = json.dumps(step5.get("sources", []), ensure_ascii=False)

    prompt = template.render(
        keyword="営業 採用 難しい",
        integration_package=integration_package,
        human_touch_elements=human_touch,
        primary_sources=primary_sources,
        cta_info="",
    )
    print(f"プロンプト文字数: {len(prompt)}")

    # ---- 4. Geminiを直接呼び出す ----
    from apps.api.llm.gemini import GeminiClient
    from apps.api.llm.schemas import LLMRequestConfig

    client = GeminiClient(model="gemini-2.5-pro")
    response = await client.generate(
        messages=[{"role": "user", "content": prompt}],
        system_prompt="You are an SEO content writer.",
        config=LLMRequestConfig(max_tokens=24000, temperature=0.7),
    )

    # ---- 5. 結果を確認 ----
    draft = response.content
    print(f"出力文字数: {len(draft)}")
    print(f"トークン: input={response.token_usage.input}, output={response.token_usage.output}, thinking={response.token_usage.thinking}")
    print(f"H2数: {draft.count('## ')}")

    import re
    print(f"脚注数: {len(re.findall(r'\\[\\d+\\]', draft))}")
    print(f"統計データ数: {len(re.findall(r'[\\d,.]+[%倍万億件社人名]', draft))}")

    # ドラフトの冒頭と末尾を表示
    print("\\n=== 冒頭500文字 ===")
    print(draft[:500])
    print("\\n=== 末尾500文字（参考文献リスト確認用）===")
    print(draft[-500:])

asyncio.run(test_step())
SCRIPT
```

**ステップ別の入力対応表**:

| テスト対象 | MinIOから取得する入力 | 変数名 |
|-----------|-------------------|--------|
| step4（骨格） | step3a, step3b, step3c, step3_5 | keyword, query_analysis, cooccurrence_keywords, competitor_analysis, human_touch_elements |
| step7a（ドラフト） | step6_5, step3_5, step5 | keyword, integration_package, human_touch_elements, primary_sources |
| step9（最終編集） | step7b, step8 | polished_draft, factcheck_result, faq_items |
| step10（4記事） | step9 | final_content, cta_specification |

**利点**:
- 1ステップ約$0.10-0.15で検証可能（全体$1.41の1/10）
- 実行時間2-5分（全体30分以上の1/10）
- 同じ入力データで改善前後のA/B比較が容易
- 改善対象外のステップを無駄に再実行しない

**MinIO UIでの成果物確認**: http://localhost:9001 （minioadmin/minioadmin）
パス: `seo-artifacts/storage/{tenant_id}/{run_id}/{step}/output.json`

### テスト実行方法（全ステップ通し — 最終確認用）

プロンプト改善が完了し、全体を通して確認したい場合のみ使用:

```bash
# workerリビルド
docker compose up -d --build worker

# APIからRun作成
curl -X POST http://localhost:28000/api/runs \
  -H "Authorization: Bearer dev-token" \
  -H "Content-Type: application/json" \
  -d '{"input":{"keyword":"営業 採用 難しい"},"model_config":{"platform":"gemini","model":"gemini-2.5-pro"}}'

# step1承認（SERP取得完了後）
curl -X POST http://localhost:28000/api/runs/{RUN_ID}/step1/approve \
  -H "Authorization: Bearer dev-token"

# step3承認（競合分析完了後）
curl -X POST http://localhost:28000/api/runs/{RUN_ID}/approve \
  -H "Authorization: Bearer dev-token"

# step11スキップ（画像不要時）
curl -X POST http://localhost:28000/api/runs/{RUN_ID}/step11/skip \
  -H "Authorization: Bearer dev-token"

# コスト確認
curl http://localhost:28000/api/runs/{RUN_ID}/cost \
  -H "Authorization: Bearer dev-token"
```

---

## 5. 品質チェックリスト

プロンプト改善後、以下を確認:

- [ ] jReadability 2.9以上を維持しているか
- [ ] 文字数 10,000文字以上か（step9）
- [ ] 統計データ 30件以上か
- [ ] 脚注参照 8件以上か（改善目標）
- [ ] 脚注に出典名+URLがあるか
- [ ] 権威ソース 3種以上引用されているか
- [ ] CTA指標 10件以上か
- [ ] Early/Mid/Final CTAが配置されているか
- [ ] FAQ 8項目以上か
- [ ] H2数 40以上か（改善目標）
- [ ] step10で脚注が維持されているか（改善目標）
- [ ] コスト $2.00以下か
- [ ] 共起語カバレッジ 80%以上か

---

## 6. 改善優先順位

| 順位 | 対象 | 改善内容 | 期待効果 |
|------|------|---------|---------|
| 1 | step7a | 参考文献リスト品質の厳格化 | 脚注 5→8+ |
| 2 | step7a | 権威ソース複数引用の必須化 | ソース 1→3+ |
| 3 | step10 | 脚注維持指示の追加 | step10脚注 0→5+ |
| 4 | step4 | H2数の最低目標指定 | H2 34→40+ |
| 5 | step9 | CTA文言の具体化 | CTA品質向上 |
