{
  "title": "GUI全フロー実行テスト",
  "description": "GUIから全ワークフローを実行可能であることを確認するテスト計画",
  "created_at": "2025-12-17T12:30:00Z",
  "environment": {
    "hot_reload": {
      "api": {
        "command": "uvicorn apps.api.main:app --reload --host 0.0.0.0 --port 8000",
        "note": "ホットリロード中。コード変更時は自動再起動されるが、Temporal接続はAPIサーバー起動時に一度だけ行われる"
      },
      "ui": {
        "command": "npm run dev (apps/ui)",
        "port": 3000,
        "note": "Next.js開発サーバー。ホットリロード有効"
      }
    },
    "debug_logs": {
      "markers": {
        "start": "===== DEBUG_LOG_START =====",
        "end": "===== DEBUG_LOG_END ====="
      },
      "locations": [
        {
          "file": "apps/worker/graphs/pre_approval.py",
          "description": "LangGraph step実行ログ（step0, step1の開始・完了）"
        },
        {
          "file": "apps/api/main.py",
          "description": "create_run()でのTemporal接続状態ログ"
        },
        {
          "file": "apps/ui/src/app/runs/[id]/page.tsx",
          "description": "Network (Debug)タブ - ポーリング状態確認UI"
        }
      ],
      "removal_command": "grep -rn 'DEBUG_LOG_START' apps/ | cut -d: -f1 | sort -u"
    }
  },
  "prerequisites": [
    {
      "id": "PRE-001",
      "task": "Dockerコンテナが起動していることを確認",
      "command": "docker compose ps",
      "expected": "postgres, minio, temporal, temporal-ui が healthy/Up 状態",
      "status": "pending"
    },
    {
      "id": "PRE-002",
      "task": "APIサーバーがTemporalに接続されていることを確認",
      "command": "curl -s http://localhost:8000/health/detailed | jq .",
      "expected": "services.temporal が 'healthy' であること",
      "note": "not_connected の場合はAPIサーバーを再起動",
      "status": "pending"
    },
    {
      "id": "PRE-003",
      "task": "Temporal Workerが起動していることを確認",
      "command": "docker compose logs worker 2>&1 | tail -20 または手動起動: uv run python -m apps.worker.main",
      "expected": "Worker started, listening on task queue: seo-article-generation",
      "note": "Workerが起動していないとワークフローが進まない",
      "status": "pending"
    },
    {
      "id": "PRE-004",
      "task": "テナントDBが存在することを確認",
      "command": "docker compose exec postgres psql -U seo -d postgres -c \"SELECT datname FROM pg_database WHERE datname LIKE 'seo%'\"",
      "expected": "seo_gen_common, seo_tenant_dev_tenant_001 が存在",
      "status": "pending"
    }
  ],
  "test_steps": [
    {
      "id": "TEST-001",
      "phase": "Run作成",
      "task": "UIからRunを作成",
      "steps": [
        "1. http://localhost:3000 にアクセス",
        "2. 「新規Run作成」ボタンをクリック",
        "3. キーワード: 'テストキーワード' を入力",
        "4. モデル: gemini-2.0-flash-exp を選択",
        "5. 「作成」ボタンをクリック"
      ],
      "expected": "Runが作成され、Run詳細ページに遷移。statusが 'running' になる",
      "fallback_check": {
        "condition": "statusが 'pending' のままの場合",
        "cause": "Temporal clientが接続されていない",
        "fix": "APIサーバーを再起動し、health/detailedでtemporal: healthyを確認"
      },
      "status": "pending"
    },
    {
      "id": "TEST-002",
      "phase": "Workflow実行確認",
      "task": "ワークフローが進行していることを確認",
      "steps": [
        "1. Run詳細ページで「Network (Debug)」タブを開く",
        "2. 「Auto-poll」にチェックを入れる",
        "3. status と current_step の変化を観察"
      ],
      "expected": "statusが 'running'、current_stepが step0 → step1 → ... と進む",
      "debug_check": {
        "api_logs": "APIサーバーのコンソールで [STEP0], [STEP1] などのログを確認",
        "temporal_ui": "http://localhost:8080 でワークフロー実行状況を確認"
      },
      "status": "pending"
    },
    {
      "id": "TEST-003",
      "phase": "承認待ち",
      "task": "Step3完了後、承認待ち状態になることを確認",
      "expected": "statusが 'waiting_approval' になり、承認ボタンが表示される",
      "status": "pending"
    },
    {
      "id": "TEST-004",
      "phase": "承認",
      "task": "承認ダイアログで承認を実行",
      "steps": [
        "1. 「承認待ち」ボタンをクリック",
        "2. 承認ダイアログで「承認」を選択"
      ],
      "expected": "statusが 'running' に戻り、step4以降が実行開始",
      "status": "pending"
    },
    {
      "id": "TEST-005",
      "phase": "完了",
      "task": "全ステップ完了を確認",
      "expected": "statusが 'completed' になり、プレビューボタンが表示される",
      "status": "pending"
    },
    {
      "id": "TEST-006",
      "phase": "成果物確認",
      "task": "生成された成果物を確認",
      "steps": [
        "1. 「成果物」タブを開く",
        "2. 各ステップの出力JSONを確認"
      ],
      "expected": "各ステップのartifactが表示される",
      "status": "pending"
    }
  ],
  "troubleshooting": [
    {
      "symptom": "Runが 'pending' のまま進まない",
      "causes": [
        "Temporal clientが接続されていない (health/detailed で確認)",
        "Temporal Workerが起動していない"
      ],
      "solutions": [
        "APIサーバーを再起動",
        "Workerを起動: uv run python -m apps.worker.main"
      ]
    },
    {
      "symptom": "Runが 'running' だが current_step が変わらない",
      "causes": [
        "Workerがタスクを処理していない",
        "LLM API呼び出しでエラーが発生"
      ],
      "solutions": [
        "Workerのログを確認",
        "Temporal UI (localhost:8080) でワークフロー履歴を確認",
        "GEMINI_API_KEY などの環境変数を確認"
      ]
    },
    {
      "symptom": "500 Internal Server Error",
      "causes": [
        "テナントDBが存在しない",
        "DB接続情報が間違っている"
      ],
      "solutions": [
        "PRE-004 のテナントDB確認を実行",
        ".env の COMMON_DATABASE_URL を確認"
      ]
    }
  ],
  "api_test_commands": {
    "login": "curl -s -X POST http://localhost:8000/api/auth/login -H 'Content-Type: application/json' -d '{\"email\":\"test@example.com\",\"password\":\"testpassword\"}' | jq -r '.access_token'",
    "create_run": "TOKEN=$(上記コマンド); curl -s -X POST http://localhost:8000/api/runs -H 'Content-Type: application/json' -H \"Authorization: Bearer $TOKEN\" -d '{\"input\":{\"keyword\":\"テスト\",\"target_audience\":\"一般\",\"competitor_urls\":[],\"additional_requirements\":\"\"},\"model_config\":{\"platform\":\"gemini\",\"model\":\"gemini-2.0-flash-exp\",\"options\":{\"grounding\":true,\"temperature\":0.7}}}' | jq .",
    "get_run": "curl -s http://localhost:8000/api/runs/{run_id} -H \"Authorization: Bearer $TOKEN\" | jq .",
    "health_detailed": "curl -s http://localhost:8000/health/detailed | jq ."
  },
  "completion_criteria": [
    "全てのTEST-* ステップが 'completed' になっている",
    "少なくとも1つのRunが status: completed で終了している",
    "成果物が正常に取得できる"
  ]
}
