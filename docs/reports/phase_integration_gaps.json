{
  "report": {
    "title": "PHASE間連携ギャップ分析レポート",
    "generated_at": "2025-12-17",
    "summary": "各PHASEで実装された基盤コンポーネントが次PHASEに引き継がれていない部分を洗い出し"
  },
  "overall_status": {
    "infrastructure_ready": true,
    "integration_complete": false,
    "critical_gaps": 6,
    "high_gaps": 8,
    "medium_gaps": 10
  },
  "phase_connections": [
    {
      "connection": "API → DB",
      "expected": "Run/Step/Artifact/AuditLog の永続化",
      "current": "インメモリ dict (_runs_store) のみ使用",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/api/main.py",
        "apps/api/db/tenant.py",
        "apps/api/db/models.py"
      ]
    },
    {
      "connection": "API → Temporal",
      "expected": "create_run() から ArticleWorkflow を起動",
      "current": "Temporal client の呼び出しなし",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/api/main.py",
        "apps/worker/workflows/article_workflow.py"
      ]
    },
    {
      "connection": "API → Storage",
      "expected": "成果物参照（ArtifactRef）をAPI経由で返却",
      "current": "/files エンドポイントが空リスト返却",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/api/main.py",
        "apps/api/storage/artifact_store.py"
      ]
    },
    {
      "connection": "Worker → Storage",
      "expected": "Activity完了時にstore.put()で成果物保存",
      "current": "LLM出力をそのまま返却（Storage未使用）",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/worker/graphs/pre_approval.py",
        "apps/worker/graphs/post_approval.py",
        "apps/worker/activities/base.py"
      ]
    },
    {
      "connection": "Worker Activity 登録",
      "expected": "Worker main.py で全Activityを登録",
      "current": "Activity登録なし（Workflow → Activity呼び出し不可）",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/worker/main.py",
        "apps/worker/activities/"
      ]
    },
    {
      "connection": "API → Observability",
      "expected": "EventEmitter経由でイベント → AuditLog DB保存",
      "current": "logger.info()のみ、EventEmitter未接続",
      "gap_level": "CRITICAL",
      "affected_files": [
        "apps/api/main.py",
        "apps/api/observability/events.py",
        "apps/api/db/audit.py"
      ]
    },
    {
      "connection": "UI → API (承認フロー)",
      "expected": "Approve/Reject/Retry エンドポイントが機能",
      "current": "501 Not Implemented 返却",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/api/main.py",
        "apps/ui/src/lib/api.ts"
      ]
    },
    {
      "connection": "API → WebSocket",
      "expected": "Run状態変更をリアルタイム配信",
      "current": "ping/pong のみ（イベント配信なし）",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/api/main.py",
        "apps/ui/src/lib/websocket.ts"
      ]
    },
    {
      "connection": "Temporal → LangGraph",
      "expected": "Activity が LangGraph グラフを invoke",
      "current": "Activity が直接LLM呼び出し（GraphState未使用）",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/worker/activities/",
        "apps/worker/graphs/"
      ]
    },
    {
      "connection": "LLM → Metadata記録",
      "expected": "token usage / コストを Step レコードに保存",
      "current": "response に含まれるが DB 未保存",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/worker/graphs/pre_approval.py",
        "apps/api/db/models.py"
      ]
    },
    {
      "connection": "Tools → Registry",
      "expected": "registry.get() でツール取得・実行",
      "current": "serp_fetch 等が未登録/未実装",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/api/tools/registry.py",
        "apps/worker/graphs/pre_approval.py"
      ]
    },
    {
      "connection": "Core State 統合",
      "expected": "GraphState / ExecutionContext を統一使用",
      "current": "main.py が独自 Pydantic モデル使用",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/api/core/state.py",
        "apps/api/core/context.py",
        "apps/api/main.py"
      ]
    },
    {
      "connection": "Error分類統合",
      "expected": "RETRYABLE/NON_RETRYABLE/VALIDATION_FAIL分類",
      "current": "HTTPException のみ使用",
      "gap_level": "HIGH",
      "affected_files": [
        "apps/api/core/errors.py",
        "apps/api/main.py"
      ]
    },
    {
      "connection": "Prompt DB管理",
      "expected": "PromptPackLoader.load(pack_id) でDB取得",
      "current": "プロンプト機能未実装",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/prompts/loader.py",
        "apps/api/db/models.py"
      ]
    },
    {
      "connection": "LLM Sanitizer",
      "expected": "プロンプトインジェクション対策",
      "current": "sanitizer.py 定義済みだが未使用",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/llm/sanitizer.py",
        "apps/worker/graphs/"
      ]
    },
    {
      "connection": "StructuredLogger",
      "expected": "コンテキスト変数付き構造化ログ",
      "current": "標準 logging.getLogger() 使用",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/observability/logger.py",
        "apps/api/main.py"
      ]
    },
    {
      "connection": "ArtifactRef 統一",
      "expected": "storage の ArtifactRef を全体で使用",
      "current": "main.py で別途 ArtifactRef 定義",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/storage/schemas.py",
        "apps/api/main.py"
      ]
    },
    {
      "connection": "Tool Evidence追跡",
      "expected": "URL/取得日時/抜粋/ハッシュを記録",
      "current": "Tool結果の永続化なし",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/tools/",
        "apps/worker/graphs/"
      ]
    },
    {
      "connection": "Validation統合",
      "expected": "JSON/CSV出力の検証実行",
      "current": "validation/ モジュール未使用",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/validation/",
        "apps/worker/graphs/"
      ]
    },
    {
      "connection": "Cost集計API",
      "expected": "/api/runs/{id}/cost でコスト返却",
      "current": "エンドポイント未実装",
      "gap_level": "MEDIUM",
      "affected_files": [
        "apps/api/main.py"
      ]
    }
  ],
  "gap_details": {
    "critical": [
      {
        "id": "GAP-001",
        "title": "DB永続化の未実装",
        "description": "TenantDBManager は完全に実装済みだが、API層で一切使用されていない。_runs_store（インメモリdict）でRunを管理しており、サーバー再起動で全データ消失。",
        "current_code": "_runs_store[(tenant_id, run_id)] = run",
        "expected_code": "async with db_manager.get_session(tenant_id) as session:\n    db_run = Run(id=run_id, ...)\n    session.add(db_run)\n    await session.commit()",
        "fix_location": "apps/api/main.py:create_run()"
      },
      {
        "id": "GAP-002",
        "title": "Temporal Workflow 未起動",
        "description": "create_run() で Run を作成するが、ArticleWorkflow を Temporal に投入していない。ワークフローが実行されない。",
        "current_code": "return run  # Workflow起動なし",
        "expected_code": "await temporal_client.start_workflow(\n    ArticleWorkflow.run,\n    tenant_id=tenant_id,\n    run_id=run_id,\n    id=run_id,\n    task_queue='default'\n)",
        "fix_location": "apps/api/main.py:create_run()"
      },
      {
        "id": "GAP-003",
        "title": "Worker Activity 未登録",
        "description": "ArticleWorkflow は Activity 名で呼び出すが、対応する Activity 関数が Worker に登録されていない。Workflow → Activity 呼び出しが失敗する。",
        "current_code": "# Worker main.py: activities=[] 空",
        "expected_code": "worker = Worker(\n    client, 'default',\n    activities=[step0_activity, step1_activity, ...]\n)",
        "fix_location": "apps/worker/main.py"
      },
      {
        "id": "GAP-004",
        "title": "成果物の Storage 未保存",
        "description": "Activity（step0-10）が LLM 出力をそのまま返却。ArtifactStore.put() が呼ばれず、成果物が永続化されない。",
        "current_code": "return {'analysis': response.content}  # 大きいJSONをそのまま返す",
        "expected_code": "artifact_ref = await store.put(\n    content=json.dumps(result).encode(),\n    path=store.build_path(tenant_id, run_id, 'step0')\n)\nreturn {'artifact_ref': artifact_ref}",
        "fix_location": "apps/worker/graphs/pre_approval.py, post_approval.py"
      },
      {
        "id": "GAP-005",
        "title": "イベント記録の未実装",
        "description": "EventEmitter / AuditLogger は定義済みだが、API操作時に呼び出されていない。監査ログが記録されない。",
        "current_code": "logger.info(f'Run created: {run_id}')",
        "expected_code": "await event_emitter.emit(Event(\n    type=EventType.RUN_CREATED,\n    tenant_id=tenant_id,\n    run_id=run_id\n))",
        "fix_location": "apps/api/main.py 全エンドポイント"
      },
      {
        "id": "GAP-006",
        "title": "Files API の未実装",
        "description": "GET /api/runs/{id}/files が空リストを返却。ArtifactStore から成果物リストを取得していない。",
        "current_code": "return []  # 空リスト",
        "expected_code": "artifacts = await artifact_store.list(tenant_id, run_id)\nreturn [ArtifactRef(...) for a in artifacts]",
        "fix_location": "apps/api/main.py:list_artifacts()"
      }
    ],
    "high": [
      {
        "id": "GAP-007",
        "title": "Approve/Reject 未実装",
        "description": "POST /api/runs/{id}/approve, /reject が 501 返却。Temporal signal 送信が実装されていない。",
        "fix_location": "apps/api/main.py:approve_run(), reject_run()"
      },
      {
        "id": "GAP-008",
        "title": "WebSocket イベント配信なし",
        "description": "WS /ws/runs/{id} が ping/pong のみ。Run状態変更時のイベント配信がない。",
        "fix_location": "apps/api/main.py:websocket_endpoint()"
      },
      {
        "id": "GAP-009",
        "title": "Activity → LangGraph 呼び出しなし",
        "description": "Activity が直接 LLM を呼び出し、LangGraph グラフを invoke していない。GraphState が活用されていない。",
        "fix_location": "apps/worker/activities/"
      },
      {
        "id": "GAP-010",
        "title": "Token Usage の DB 未保存",
        "description": "LLM 呼び出しの token usage が response に含まれるが、Step レコードに保存されていない。",
        "fix_location": "apps/worker/graphs/pre_approval.py"
      },
      {
        "id": "GAP-011",
        "title": "Tool Registry 未統合",
        "description": "registry.get('serp_fetch') が実装されていない。Tool 呼び出しが失敗する。",
        "fix_location": "apps/api/tools/registry.py"
      },
      {
        "id": "GAP-012",
        "title": "Core State 未統一",
        "description": "main.py が独自 Pydantic モデルを使用。core/state.py の GraphState が活用されていない。",
        "fix_location": "apps/api/main.py"
      },
      {
        "id": "GAP-013",
        "title": "Error分類 未使用",
        "description": "core/errors.py の ErrorCategory が使用されていない。全てが HTTPException で処理される。",
        "fix_location": "apps/api/main.py"
      },
      {
        "id": "GAP-014",
        "title": "Retry/Cancel 未実装",
        "description": "POST /api/runs/{id}/retry/{step}, DELETE /api/runs/{id} が 501 返却。",
        "fix_location": "apps/api/main.py"
      }
    ],
    "medium": [
      {
        "id": "GAP-015",
        "title": "Prompt DB管理 未実装",
        "description": "PromptPackLoader.load() が呼ばれていない。プロンプトがハードコード状態。"
      },
      {
        "id": "GAP-016",
        "title": "LLM Sanitizer 未使用",
        "description": "llm/sanitizer.py が定義済みだが、プロンプト処理で使用されていない。"
      },
      {
        "id": "GAP-017",
        "title": "StructuredLogger 未統合",
        "description": "observability/logger.py が未使用。標準 logging が使われている。"
      },
      {
        "id": "GAP-018",
        "title": "ArtifactRef 重複定義",
        "description": "main.py と storage/schemas.py で別々に ArtifactRef を定義。"
      },
      {
        "id": "GAP-019",
        "title": "Tool Evidence 追跡なし",
        "description": "Tool 実行結果（URL, 取得日時, ハッシュ）が記録されていない。"
      },
      {
        "id": "GAP-020",
        "title": "Validation 未実行",
        "description": "validation/ モジュールが未使用。出力の検証がない。"
      },
      {
        "id": "GAP-021",
        "title": "Cost API 未実装",
        "description": "/api/runs/{id}/cost エンドポイントが未実装。"
      },
      {
        "id": "GAP-022",
        "title": "Health Check 簡易版のみ",
        "description": "/health/detailed が未実装。DB/Storage/Temporal 接続状態が不明。"
      },
      {
        "id": "GAP-023",
        "title": "Preview API 未実装",
        "description": "GET /api/runs/{id}/preview が 404 返却。成果物プレビュー不可。"
      },
      {
        "id": "GAP-024",
        "title": "Events API 空実装",
        "description": "GET /api/runs/{id}/events が空リスト返却。イベント履歴取得不可。"
      }
    ]
  },
  "recommended_fix_order": {
    "phase0_immediate": {
      "description": "インフラ接続（即座に対応）",
      "tasks": [
        "GAP-001: TenantDBManager を FastAPI lifespan で初期化、create_run() を DB保存に修正",
        "GAP-005: EventEmitter を DB に接続、create_run() でイベント記録"
      ],
      "estimated_files": 2
    },
    "phase1_temporal": {
      "description": "Temporal 連携",
      "tasks": [
        "GAP-002: create_run() から Temporal workflow 投入",
        "GAP-003: Worker main.py で全 Activity 登録",
        "GAP-007: Approve/Reject で Temporal signal 送信"
      ],
      "estimated_files": 3
    },
    "phase2_storage": {
      "description": "Storage 統合",
      "tasks": [
        "GAP-004: Activity 実装で store.put() 呼び出し",
        "GAP-006: Files API で artifacts list 返却"
      ],
      "estimated_files": 4
    },
    "phase3_ui": {
      "description": "UI 完成",
      "tasks": [
        "GAP-008: WebSocket イベント配信",
        "GAP-014: Retry/Cancel 実装"
      ],
      "estimated_files": 2
    },
    "phase4_polish": {
      "description": "仕上げ",
      "tasks": [
        "GAP-009〜024: 残りの MEDIUM ギャップ対応"
      ],
      "estimated_files": 10
    }
  },
  "security_considerations": [
    {
      "id": "SEC-001",
      "title": "WebSocket 認証なし",
      "description": "/ws/runs/{id} で認証がスキップされている（development モード）",
      "risk": "HIGH",
      "recommendation": "JWT検証を必須化"
    },
    {
      "id": "SEC-002",
      "title": "tenant_id URL 受け入れリスク",
      "description": "一部エンドポイントでURL/クエリから tenant_id を受け入れる可能性",
      "risk": "MEDIUM",
      "recommendation": "常に user.tenant_id を使用"
    }
  ],
  "notes": [
    "基盤層（DB, Storage, Core, Observability）は全て実装済み",
    "問題は「呼び出し側」が基盤を使っていないこと",
    "修正難易度は低い（接続コードを追加するだけ）",
    "Alembic マイグレーションは用意済み（apps/api/db/migrations/）",
    "Docker Compose で全インフラ起動可能"
  ]
}
