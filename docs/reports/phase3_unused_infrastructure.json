{
  "report": {
    "title": "PHASE3 インフラ未活用箇所リスト",
    "generated_at": "2025-12-17",
    "summary": "PHASE3で実装されたインフラコンポーネントのうち、main.py (API) で活用されていない部分を洗い出し"
  },
  "unused_components": [
    {
      "id": "DB-001",
      "module": "apps/api/db",
      "component": "TenantDBManager",
      "description": "マルチテナントDB接続管理",
      "current_status": "未使用",
      "current_implementation": "main.py で _runs_store (インメモリ dict) を使用",
      "expected_usage": "TenantDBManager.get_session(tenant_id) で顧客別DBに接続",
      "affected_endpoints": [
        "POST /api/runs",
        "GET /api/runs",
        "GET /api/runs/{run_id}",
        "POST /api/runs/{run_id}/approve",
        "POST /api/runs/{run_id}/reject",
        "DELETE /api/runs/{run_id}"
      ],
      "priority": "HIGH"
    },
    {
      "id": "DB-002",
      "module": "apps/api/db/models.py",
      "component": "Run (ORM Model)",
      "description": "ワークフロー実行レコード",
      "current_status": "未使用",
      "current_implementation": "main.py の RunResponse (Pydantic) を直接使用",
      "expected_usage": "DB に Run レコードを保存・取得",
      "priority": "HIGH"
    },
    {
      "id": "DB-003",
      "module": "apps/api/db/models.py",
      "component": "Step (ORM Model)",
      "description": "工程ステップ記録",
      "current_status": "未使用",
      "current_implementation": "main.py の StepResponse (Pydantic) をスタブで返却",
      "expected_usage": "各工程の実行状態をDBに記録",
      "priority": "MEDIUM"
    },
    {
      "id": "DB-004",
      "module": "apps/api/db/models.py",
      "component": "Artifact (ORM Model)",
      "description": "成果物メタデータ",
      "current_status": "未使用",
      "current_implementation": "main.py で空リストを返却",
      "expected_usage": "ArtifactStore と連携してメタデータをDBに保存",
      "priority": "MEDIUM"
    },
    {
      "id": "DB-005",
      "module": "apps/api/db/models.py",
      "component": "AuditLog (ORM Model)",
      "description": "監査ログ（チェーンハッシュ付き）",
      "current_status": "未使用",
      "current_implementation": "main.py で events エンドポイントが空リストを返却",
      "expected_usage": "approve/reject/retry等の操作を監査ログに記録",
      "priority": "HIGH"
    },
    {
      "id": "DB-006",
      "module": "apps/api/db/audit.py",
      "component": "AuditLogger",
      "description": "監査ログ記録ユーティリティ",
      "current_status": "未使用",
      "current_implementation": "logger.info() のみ使用",
      "expected_usage": "AuditLogger.log() で監査ログをDBに記録",
      "priority": "HIGH"
    },
    {
      "id": "STORAGE-001",
      "module": "apps/api/storage",
      "component": "ArtifactStore",
      "description": "MinIO連携の成果物ストア",
      "current_status": "未使用",
      "current_implementation": "成果物APIが空リスト/404を返却",
      "expected_usage": "ArtifactStore.put/get で成果物を保存・取得",
      "affected_endpoints": [
        "GET /api/runs/{run_id}/files",
        "GET /api/runs/{run_id}/files/{step}",
        "GET /api/runs/{run_id}/files/{artifact_id}/content",
        "GET /api/runs/{run_id}/preview"
      ],
      "priority": "HIGH"
    },
    {
      "id": "STORAGE-002",
      "module": "apps/api/storage/schemas.py",
      "component": "ArtifactRef",
      "description": "成果物参照スキーマ（path + digest）",
      "current_status": "未使用",
      "current_implementation": "main.py の ArtifactRef は別途定義",
      "expected_usage": "storage の ArtifactRef を統一使用",
      "priority": "MEDIUM"
    },
    {
      "id": "CORE-001",
      "module": "apps/api/core/state.py",
      "component": "GraphState",
      "description": "LangGraph用中央ステートスキーマ",
      "current_status": "未使用",
      "current_implementation": "main.py で独自の Pydantic モデルを定義",
      "expected_usage": "Temporal/LangGraph 連携時にステート管理",
      "priority": "MEDIUM"
    },
    {
      "id": "CORE-002",
      "module": "apps/api/core/context.py",
      "component": "ExecutionContext",
      "description": "リトライ追跡、タイムアウト設定",
      "current_status": "未使用",
      "current_implementation": "リトライロジック未実装",
      "expected_usage": "Activity 実行時のリトライ/タイムアウト管理",
      "priority": "MEDIUM"
    },
    {
      "id": "CORE-003",
      "module": "apps/api/core/errors.py",
      "component": "ErrorCategory, StepError",
      "description": "エラー分類とリトライ判定",
      "current_status": "未使用",
      "current_implementation": "HTTPException のみ使用",
      "expected_usage": "RETRYABLE/NON_RETRYABLE/VALIDATION_FAIL の分類",
      "priority": "MEDIUM"
    },
    {
      "id": "OBS-001",
      "module": "apps/api/observability/events.py",
      "component": "EventEmitter, EventType",
      "description": "構造化イベント発行",
      "current_status": "未使用",
      "current_implementation": "logger.info/warning のみ使用",
      "expected_usage": "EventEmitter.emit() で構造化イベントを発行",
      "priority": "LOW"
    },
    {
      "id": "OBS-002",
      "module": "apps/api/observability/logger.py",
      "component": "StructuredLogger",
      "description": "コンテキスト変数付き構造化ログ",
      "current_status": "未使用",
      "current_implementation": "標準 logging.getLogger() を使用",
      "expected_usage": "StructuredLogger でコンテキスト情報を統一付与",
      "priority": "LOW"
    },
    {
      "id": "PROMPT-001",
      "module": "apps/api/prompts/loader.py",
      "component": "PromptPackLoader",
      "description": "DBからのプロンプトロード（pack_id必須）",
      "current_status": "未使用",
      "current_implementation": "プロンプト機能未実装",
      "expected_usage": "PromptPackLoader.load(pack_id) でプロンプトを取得",
      "priority": "MEDIUM"
    },
    {
      "id": "PROMPT-002",
      "module": "apps/api/db/models.py",
      "component": "Prompt (ORM Model)",
      "description": "バージョン管理付きプロンプト",
      "current_status": "未使用",
      "current_implementation": "プロンプトテーブル未使用",
      "expected_usage": "step + version でプロンプトをDB管理",
      "priority": "MEDIUM"
    }
  ],
  "implementation_order": {
    "phase1_critical": [
      "DB-001: TenantDBManager 統合",
      "DB-002: Run ORM モデル使用",
      "DB-005: AuditLog 監査ログ実装",
      "DB-006: AuditLogger 統合",
      "STORAGE-001: ArtifactStore 統合"
    ],
    "phase2_important": [
      "DB-003: Step ORM モデル使用",
      "DB-004: Artifact ORM モデル使用",
      "STORAGE-002: ArtifactRef 統一",
      "CORE-001: GraphState 統合",
      "PROMPT-001: PromptPackLoader 統合",
      "PROMPT-002: Prompt モデル使用"
    ],
    "phase3_enhancement": [
      "CORE-002: ExecutionContext 統合",
      "CORE-003: ErrorCategory 統合",
      "OBS-001: EventEmitter 統合",
      "OBS-002: StructuredLogger 統合"
    ]
  },
  "notes": [
    "main.py は現在スタブ実装で、PHASE3 インフラを一切使用していない",
    "認証は ENVIRONMENT=development で SKIP_AUTH=True に設定済み",
    "インメモリストア (_runs_store) はサーバー再起動で消失",
    "PostgreSQL + MinIO は docker-compose で起動可能な状態",
    "Alembic マイグレーションは apps/api/db/migrations/ に用意済み"
  ]
}
