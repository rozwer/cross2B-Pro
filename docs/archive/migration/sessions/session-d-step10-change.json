{
  "session_id": "D",
  "phase": "4",
  "title": "工程10（最終出力）4記事出力への変更",
  "description": "現行の単一記事出力から、4つの記事を出力する形式に変更",
  "dependencies": [],
  "estimated_files": 4,

  "tasks": [
    {
      "id": "D-1",
      "type": "schema",
      "description": "step10のスキーマを4記事出力に変更",
      "file": "apps/worker/activities/schemas/step10.py",
      "details": {
        "current_output": {
          "final_article": "string (単一記事)"
        },
        "new_output": {
          "articles": [
            {
              "article_number": "int (1-4)",
              "title": "string",
              "content": "string (Markdown)",
              "word_count": "int",
              "target_audience": "string",
              "variation_type": "string (メイン/初心者向け/実践編/まとめ)"
            }
          ],
          "output_path": "string",
          "output_digest": "string"
        }
      }
    },
    {
      "id": "D-2",
      "type": "prompt",
      "description": "step10プロンプトを4記事生成用に更新",
      "file": "apps/api/prompts/packs/step10.json",
      "details": {
        "changes": [
          "4つのバリエーション記事を生成する指示を追加",
          "各記事の差別化ポイントを明確化",
          "ターゲット読者層の違いを反映"
        ],
        "article_variations": [
          {
            "number": 1,
            "type": "メイン記事",
            "description": "最も包括的で詳細な記事"
          },
          {
            "number": 2,
            "type": "初心者向け",
            "description": "基礎から丁寧に説明"
          },
          {
            "number": 3,
            "type": "実践編",
            "description": "具体的なアクションにフォーカス"
          },
          {
            "number": 4,
            "type": "まとめ・比較",
            "description": "要点を簡潔にまとめた記事"
          }
        ]
      }
    },
    {
      "id": "D-3",
      "type": "activity",
      "description": "step10のActivity実装を更新",
      "file": "apps/worker/activities/step10.py",
      "details": {
        "execution_strategy": {
          "mode": "sequential",
          "reason": "各記事の一貫性確保とコンテキスト共有のため順次生成",
          "per_article_timeout": "150秒",
          "total_timeout": "600秒"
        },
        "changes": [
          "4記事分のLLM呼び出し（順次実行）",
          "前の記事の要約を次の記事生成時にコンテキストとして渡す",
          "各記事の独立した保存（step10/article_1.md, article_2.md, ...）",
          "統合出力ファイルの生成（step10/output.json）"
        ],
        "error_handling": {
          "partial_failure": "生成済み記事は保存、失敗記事のみリトライ",
          "retry_policy": "最大3回/記事"
        },
        "note": "並列生成は内容重複リスクがあるため順次を推奨"
      }
    },
    {
      "id": "D-4",
      "type": "test",
      "description": "step10のテストを4記事対応に更新",
      "file": "tests/unit/test_step10.py",
      "details": {
        "test_cases": [
          "正常系: 4記事が生成される",
          "各記事の差別化: 内容が重複しない",
          "文字数: 各記事が最低限の文字数を満たす",
          "出力形式: 正しいJSON構造"
        ]
      }
    }
  ],

  "output_spec": {
    "file_name": "工程10_最終記事.json",
    "storage_path": "storage/{tenant_id}/{run_id}/step10/output.json",
    "format": {
      "articles": [
        {
          "article_number": 1,
          "variation_type": "メイン記事",
          "title": "string",
          "content": "string (Markdown)",
          "word_count": "int (目標: 5000-8000字)",
          "sections": ["string"]
        },
        {
          "article_number": 2,
          "variation_type": "初心者向け",
          "title": "string",
          "content": "string (Markdown)",
          "word_count": "int (目標: 3000-5000字)",
          "sections": ["string"]
        },
        {
          "article_number": 3,
          "variation_type": "実践編",
          "title": "string",
          "content": "string (Markdown)",
          "word_count": "int (目標: 4000-6000字)",
          "sections": ["string"]
        },
        {
          "article_number": 4,
          "variation_type": "まとめ・比較",
          "title": "string",
          "content": "string (Markdown)",
          "word_count": "int (目標: 2000-3000字)",
          "sections": ["string"]
        }
      ],
      "metadata": {
        "generated_at": "datetime",
        "model": "string",
        "total_word_count": "int"
      }
    }
  },

  "acceptance_criteria": [
    "4つの記事が生成される",
    "各記事のバリエーションタイプが明確",
    "記事間で内容の重複が最小限",
    "各記事が独立して読める",
    "step11, step12で4記事すべてが処理される",
    "冪等性が保証される"
  ],

  "breaking_changes": [
    {
      "component": "step9 → step10",
      "impact": "step9の出力を4記事生成の共通ベースとして使用",
      "action": "step9出力を各記事バリエーションの基礎として参照"
    },
    {
      "component": "step11",
      "impact": "4記事分の画像提案が必要",
      "action": "step11の入力処理を更新、articles配列をループ処理"
    },
    {
      "component": "step12",
      "impact": "4記事分のWordPress HTML生成",
      "action": "step12で4記事対応（Session Cと連携）"
    },
    {
      "component": "API preview",
      "impact": "プレビューAPIが4記事対応必要",
      "action": "GET /api/runs/{id}/preview?article=1 のようにクエリパラメータ追加"
    },
    {
      "component": "WebSocket",
      "impact": "進捗通知が4記事の進捗を反映する必要",
      "action": "進捗メッセージに article_number フィールドを追加"
    },
    {
      "component": "UI",
      "impact": "記事一覧表示が必要",
      "action": "タブまたはカルーセルで4記事表示"
    },
    {
      "component": "audit_log",
      "impact": "4記事のメタデータ記録",
      "action": "output_digestを記事ごとに記録"
    }
  ],

  "backward_compatibility": {
    "old_runs": "既存runは単一記事として扱い、articles[0]にマッピング",
    "api_response": "articlesフィールドがない場合はfinal_articleをarticles[0]として返す",
    "migration": "既存データの自動変換は不要（読み取り時に互換層で対応）"
  }
}
