{
  "session_id": "C",
  "phase": "1C",
  "title": "工程12（WordPress用HTML生成）新規追加",
  "description": "最終記事と画像提案を元にWordPress用HTMLを生成する工程を新規実装",
  "dependencies": [],
  "estimated_files": 7,

  "tasks": [
    {
      "id": "C-1",
      "type": "schema",
      "description": "step12のスキーマ定義を作成",
      "file": "apps/worker/activities/schemas/step12.py",
      "details": {
        "input": {
          "step0_output": "dict (キーワード情報)",
          "step6_5_output": "dict (構成案)",
          "step10_output": "dict (最終記事4本)",
          "step11_output": "dict (画像提案)",
          "tenant_id": "string",
          "run_id": "string"
        },
        "output": {
          "wordpress_html": "list[dict] (4記事分のHTML)",
          "output_path": "string",
          "output_digest": "string"
        }
      }
    },
    {
      "id": "C-2",
      "type": "activity",
      "description": "step12のActivity実装",
      "file": "apps/worker/activities/step12.py",
      "details": {
        "activity_name": "step12_wordpress_html_generation",
        "ai_model": "Claude（構造化担当）",
        "timeout": "300秒",
        "retry_policy": "最大3回",
        "input_files_count": 5
      }
    },
    {
      "id": "C-3",
      "type": "prompt",
      "description": "step12用プロンプトテンプレート作成",
      "file": "apps/api/prompts/packs/step12.json",
      "details": {
        "template_name": "wordpress_html_generation",
        "variables": [
          "article_content",
          "image_placements",
          "seo_metadata",
          "structure_outline"
        ],
        "output_format": "HTML",
        "key_elements": [
          "WordPress Gutenbergブロック形式",
          "画像タグの適切な挿入",
          "SEOメタデータ埋め込み",
          "レスポンシブ対応クラス"
        ]
      }
    },
    {
      "id": "C-4",
      "type": "workflow",
      "description": "post_approval.pyの末尾に工程12を追加（step11の後）",
      "file": "apps/worker/graphs/post_approval.py",
      "details": {
        "position": "... → step10 → step11 → step12 → [完了]",
        "note": "最終工程として配置"
      }
    },
    {
      "id": "C-5",
      "type": "note",
      "description": "__init__.pyへのエクスポートはSession Fで一括追加",
      "file": "apps/worker/activities/__init__.py",
      "details": {
        "action": "このセッションでは編集しない",
        "reason": "Session F で一括追加することでマージ競合を回避",
        "verification": "step12.py 内で @activity.defn デコレータが正しく設定されていることを確認"
      }
    },
    {
      "id": "C-6",
      "type": "api",
      "description": "step12用APIエンドポイント追加（プレビュー・ダウンロード）",
      "file": "apps/api/routers/step12.py",
      "details": {
        "endpoints": [
          "GET /api/runs/{run_id}/step12/preview - HTMLプレビュー",
          "GET /api/runs/{run_id}/step12/preview?article=1 - 特定記事のプレビュー",
          "GET /api/runs/{run_id}/step12/download - ZIPダウンロード（全4記事）"
        ],
        "security": {
          "tenant_scope": "required - run.tenant_id と認証tenant_idの一致を検証",
          "audit_log": {
            "preview": "run_id, article_number, actor, timestamp を記録",
            "download": "run_id, actor, timestamp, file_count を記録"
          },
          "validation": [
            "run_idが存在し、tenant_idが一致することを確認",
            "step12が完了していることを確認（status=completed）",
            "article番号が1-4の範囲内であることを確認"
          ]
        }
      }
    },
    {
      "id": "C-7",
      "type": "test",
      "description": "step12のユニットテスト作成",
      "file": "tests/unit/test_step12.py",
      "details": {
        "test_cases": [
          "正常系: 4記事分のHTML生成",
          "画像挿入: step11の画像が正しく埋め込まれる",
          "バリデーション: 生成HTMLの構文チェック",
          "メタデータ: SEO情報が正しく埋め込まれる"
        ]
      }
    }
  ],

  "output_spec": {
    "file_name": "工程12_WordPressHTML.zip",
    "storage_path": "storage/{tenant_id}/{run_id}/step12/",
    "format": {
      "articles": [
        {
          "article_number": "int (1-4)",
          "filename": "string (article_1.html など)",
          "html_content": "string",
          "metadata": {
            "title": "string",
            "meta_description": "string",
            "focus_keyword": "string",
            "word_count": "int"
          },
          "images": [
            {
              "position": "string",
              "alt_text": "string",
              "suggested_filename": "string"
            }
          ]
        }
      ],
      "common_assets": {
        "css_classes": ["string"],
        "recommended_plugins": ["string"]
      },
      "generation_metadata": {
        "generated_at": "datetime",
        "model": "string",
        "wordpress_version_target": "string"
      }
    }
  },

  "acceptance_criteria": [
    "step11完了後に自動実行される",
    "4記事分のHTMLが生成される",
    "画像タグが適切な位置に挿入される",
    "生成HTMLがW3Cバリデーションを通過する",
    "WordPressにそのままインポート可能な形式",
    "冪等性が保証される"
  ]
}
