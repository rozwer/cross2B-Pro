# 品質向上施策 v2（スコア9.0達成に向けて）

**作成日**: 2026-02-04
**目標**: 総合スコア 6.25/10 → 9.0/10

---

## Codexとの相談結果

### 問題の根本原因

1. **統計データ収集の不安定さ**: 業界によって統計ソースの適合性が異なる
2. **CTA配置の一貫性欠如**: LLM生成に依存し、配置が不安定
3. **出典形式の混在**: 脚注形式と本文内言及が混在
4. **キーワード間の品質ばらつき**: 業界判定なしで汎用プロンプトを使用

---

## 実装した改善内容

### 1. Step0: 業界カテゴリ判定の追加

**変更箇所**: `step0` プロンプト

**追加内容**:
```
## Step 5: 業界カテゴリの判定（最重要・後続工程で使用）

| カテゴリ | 判定キーワード例 |
|---------|----------------|
| recruitment | 採用、求人、人材、転職、応募 |
| logistics | 運送、物流、配送、ドライバー、トラック |
| manufacturing | 製造、工場、整備士、技術者、エンジニア |
| sales | 営業、セールス、販売、商談 |
| general | 上記に該当しない場合 |
```

**出力JSON追加**:
```json
"industry_category": "recruitment/logistics/manufacturing/sales/general"
```

---

### 2. Step5: 必須ソースマップとINSUFFICIENT返却

**変更箇所**: `step5` プロンプト

**追加内容**:

#### 最低ソース数の厳格化
```
- **最低6件**（官公庁2件 / 業界団体2件 / 調査会社1件 / 学術1件）
- 不足時は `status: "INSUFFICIENT"` を返し、`missing_reason` を必ず記載
- **埋め草や一般論での代用は禁止**（リトライで再収集）
```

#### 業界別必須ソースマップ
```
**logistics（運送・物流）:**
1. 国土交通省（物流・運輸統計）
2. 厚生労働省（労働統計）
3. 全日本トラック協会
4. 帝国データバンク / 東京商工リサーチ
5. 学術論文（運送業の人手不足）
```
（recruitment, manufacturing, sales, general も同様に定義）

**出力JSON追加**:
```json
"status": "OK / INSUFFICIENT",
"missing_reason": "不足理由を詳細に記載",
"required_source_minimums": {
  "total": 6,
  "government": 2,
  "industry_association": 2,
  "research_company": 1,
  "academic": 1,
  "actual_counts": {...},
  "shortfall": []
}
```

---

### 3. Step6: 統計配置マップ出力の必須化

**変更箇所**: `step6` プロンプト

**追加内容**:

#### Step 0.5: 統計配置マップの必須出力
```json
"statistics_placement_map": [
  {
    "section_id": "S01",
    "h2": "見出し",
    "data_points": [
      {"source_id": "S1", "data_point": "有効求人倍率", "value": "2.59倍", "ref_id": 1}
    ]
  }
]
```

#### 脚注形式の厳格ルール
```
- 本文中の出典表記は `<sup id="refN">[N]</sup>` のみ許可
- 「出典:」や「(厚生労働省)」等の本文内併記は禁止
- 参考文献リストは必ず `[↩︎](#refN)` を含める
- 本文中の数値には必ず脚注を付与
```

---

### 4. Step9: CTA位置検証ルールの追加

**変更箇所**: `step9` プロンプト

**追加内容**:

#### CTA位置検証ルール
| CTA種別 | 配置位置（文字数） | 許容範囲 |
|---------|------------------|---------|
| Early CTA | 650字 | 500〜800字 |
| Mid CTA | 2,800字 | 2,500〜3,100字 |
| Final CTA | まとめ前 | まとめセクション直前 |

#### 検証レポート出力
```json
"cta_anchor_checks": {
  "early": {"found": true, "position_chars": 640, "within_range": true},
  "mid": {"found": true, "position_chars": 2900, "within_range": true},
  "final": {"found": true, "position_chars": 5100, "within_range": true}
}
```

---

## 期待される効果

| 評価項目 | 現状 | 目標 | 施策 |
|---------|------|------|------|
| 統計データ | 5.5/10 | 9.0/10 | 業界別ソースマップ + INSUFFICIENT返却 |
| 出典明記 | 5.0/10 | 9.0/10 | 脚注形式厳格化 + 統計配置マップ |
| CTA配置 | 5.5/10 | 9.0/10 | 位置検証ルール + 検証レポート |
| 見出し構造 | 8.0/10 | 9.0/10 | 既存で十分 |
| **総合** | **6.25/10** | **9.0/10** | - |

---

## 今後の追加施策（中期）

1. **LangGraph検証ノードの追加**
   - ソース件数検証
   - CTA位置検証
   - 脚注整合性検証

2. **リトライ戦略の統一**
   - 1回目: 局所修正
   - 2回目: セクション再生成
   - 3回目: 全文再生成

3. **外部採点ノードの導入**
   - 品質スコア0.90未満でリトライ

---

## 変更ファイル

- `apps/api/prompts/packs/v2_blog_system.json`
  - step0: version 2 → 追加（業界カテゴリ判定）
  - step5: version 3 → 追加（必須ソースマップ、INSUFFICIENT）
  - step6: version 2 → 3（統計配置マップ、脚注厳格化）
  - step9: version 2 → 3（CTA位置検証）
