# 工程構成変更 - フェーズ分割の理由

## 概要

新しい工程構成への移行を、6つの並列セッションに分割する。
各セッションは独立して実行可能であり、最後のSession Fで統合を行う。

---

## Session A: 工程1.5（関連KW競合抽出）

### なぜ独立セッションか

1. **既存コードへの影響が最小**
   - step1とstep2の間に挿入するだけ
   - 他の工程の入出力に影響しない（step2で吸収）

2. **オプショナル工程**
   - 関連キーワードがない場合はスキップ可能
   - 既存runとの後方互換性を保ちやすい

3. **外部連携の複雑さ**
   - GAS/スクレイピングとの連携が必要
   - 独立してデバッグ・調整しやすい

### 成果物
- `apps/worker/activities/step1_5.py`
- `apps/worker/activities/schemas/step1_5.py`

---

## Session B: 工程3.5（人間味・体験エピソード生成）

### なぜ独立セッションか

1. **新規コンセプトの導入**
   - 「人間味」という新しい要素の生成
   - プロンプト設計に時間がかかる可能性

2. **承認後の最初の工程**
   - post_approvalグラフの先頭に追加
   - 他の工程との依存関係が明確

3. **6ファイル入力の複雑さ**
   - step0, 1, 1.5, 3A, 3B, 3C を入力
   - 入力収集ロジックの実装が必要

### 成果物
- `apps/worker/activities/step3_5.py`
- `apps/worker/activities/schemas/step3_5.py`
- `apps/api/prompts/packs/step3_5.json`

---

## Session C: 工程12（WordPress HTML生成）

### なぜ独立セッションか

1. **最終工程として独立**
   - step11の後に追加するだけ
   - 他の工程に影響しない

2. **出力形式が特殊**
   - WordPress Gutenbergブロック形式
   - HTMLバリデーションが必要

3. **新規API/UIが必要**
   - プレビュー・ダウンロード機能
   - 独立して開発・テスト可能

### 成果物
- `apps/worker/activities/step12.py`
- `apps/api/routers/step12.py`

---

## Session D: 工程10（4記事出力への変更）

### なぜ独立セッションか

1. **既存工程の変更**
   - 新規追加ではなく、既存の変更
   - 後方互換性の考慮が必要

2. **影響範囲が広い**
   - step11, step12の入力形式に影響
   - UIでの表示変更が必要

3. **プロンプト変更が主**
   - 4記事生成用のプロンプト設計
   - LLMの出力品質の確認

### 成果物
- `apps/worker/activities/step10.py`（更新）
- `apps/api/prompts/packs/step10.json`（更新）

### 注意点
- Session C（step12）との連携確認が必要
- Session F（統合）で最終調整

---

## Session E: 工程-1（ヒアリングフォームUI）

### なぜ独立セッションか

1. **ワークフロー外の機能**
   - Temporal Workflowの実行前に行う
   - 他のセッションと完全に独立

2. **UIメインの作業**
   - フロントエンド開発が中心
   - バックエンド変更は最小限

3. **DB追加が必要**
   - hearingsテーブルの追加
   - マイグレーション作業

### 成果物
- `apps/ui/src/components/hearing/HearingForm.tsx`
- `apps/api/routers/hearing.py`
- `apps/api/models/hearing.py`

---

## Session F: 統合フェーズ

### なぜ最後に統合か

1. **依存関係の解決**
   - Session A-Eの成果物がすべて必要
   - 部分的な統合はリスクが高い

2. **ワークフロー全体の再構成**
   - pre_approval, post_approval両方を更新
   - Temporal Workflowの変更

3. **テスト網羅性**
   - E2Eテストは全工程が揃ってから
   - 後方互換性の最終確認

### 作業内容
- 既存工程の入力スキーマ更新（step2, step4, step7A）
- ワークフローグラフの再構成
- 統合テストの実行

---

## 並列実行の注意点

### ファイル競合を避ける

各セッションで編集するファイルを明確に分離：

| ファイル | Session |
|----------|---------|
| `step1_5.py` | A |
| `step3_5.py` | B |
| `step12.py` | C |
| `step10.py` | D |
| `hearing/*.py/tsx` | E |
| `pre_approval.py` | F |
| `post_approval.py` | F |
| `article_workflow.py` | F |

### `activities/__init__.py` の競合

- Session A, B, C で個別にエクスポートを追加
- Session F で最終的に統合・確認

**推奨**: 各セッション完了時に `__init__.py` への追加をコミットし、
Session F開始時に最新をpullしてから統合作業を行う。

---

## 工程の添付ファイル数（仕様確認）

| 工程 | 添付数 | 入力ファイル |
|------|--------|--------------|
| 工程-1 | 0 | UI入力 |
| 工程0 | 0 | 初期入力 |
| 工程1 | 0 | 外部スクレイピング |
| 工程1.5 | 0 | 外部スクレイピング |
| 工程2 | 3 | 工程0, 1, 1.5 |
| 工程3A/3B/3C | 2 | 工程0, 1 |
| 工程3.5 | 6 | 工程0, 1, 1.5, 3A, 3B, 3C |
| 工程4 | 7 | 工程0, 1, 1.5, 3A, 3B, 3C, 3.5 |
| 工程5 | 8 | 工程0, 1, 1.5, 3A, 3B, 3C, 3.5, 4 |
| 工程6 | 9 | 工程0, 1, 1.5, 3A, 3B, 3C, 3.5, 4, 5 |
| 工程6.5 | 10 | 工程0, 1, 1.5, 3A, 3B, 3C, 3.5, 4, 5, 6（上限） |
| 工程7A | 8 | 工程0, 3A, 3B, 3C, 3.5, 6, 6.5 |
| 工程7B | 3 | 工程3.5, 6.5, 7A |
| 工程8 | 4 | 工程0, 5, 6.5, 7B |
| 工程9 | 5 | 工程0, 5, 6.5, 8（2ファイル） |
| 工程10 | 4 | 工程0, 6.5, 9（2ファイル） |
| 工程11 | 4 | 工程0, 3A, 6.5, 10（2ファイル） |
| 工程12 | 5 | 工程0, 6.5, 10（2ファイル）, 11 |

---

## 実行順序の推奨

```
並列実行可能:
├── Session A (工程1.5)
├── Session B (工程3.5)
├── Session C (工程12)
├── Session D (工程10変更)
└── Session E (工程-1 UI)

↓ 全て完了後

Session F (統合)
```

各セッションは独立したブランチまたはworktreeで作業し、
Session F開始前にdevelopへマージすることを推奨。
