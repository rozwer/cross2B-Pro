{
  "session_id": "F",
  "phase": "2+3",
  "title": "統合フェーズ - 既存工程の入力調整 + ワークフロー統合",
  "description": "Session A-Eの成果物を統合し、既存工程の入力を調整、ワークフロー全体を再構成",
  "dependencies": ["A", "B", "C", "D", "E"],
  "estimated_files": 12,

  "prerequisite_checks": [
    {
      "session": "A",
      "check": "step1_5.py が実装済み",
      "fallback": "step1_5をスキップする分岐を追加",
      "optional": true
    },
    {
      "session": "B",
      "check": "step3_5.py が実装済み",
      "fallback": "移行期間はオプショナルとして導入、config.enable_step3_5フラグで制御",
      "optional": true,
      "migration_period": "2週間後に必須化"
    },
    {
      "session": "C",
      "check": "step12.py が実装済み",
      "fallback": "step11で終了する分岐を追加",
      "optional": true
    },
    {
      "session": "D",
      "check": "step10が4記事出力対応済み",
      "fallback": "後方互換性を維持（単一記事もサポート）",
      "optional": false
    },
    {
      "session": "E",
      "check": "hearing テンプレート機能が実装済み",
      "fallback": "オプショナルとして扱う",
      "optional": true
    }
  ],

  "backward_compatibility": {
    "existing_runs": {
      "step3_5_missing": "step3_5出力がない場合、step4はstep3a/3b/3cのみで動作",
      "step1_5_missing": "step1_5出力がない場合、step2は従来通りstep0/step1のみで動作",
      "single_article": "step10がarticles配列でなくfinal_articleの場合、articles[0]として扱う"
    },
    "resume_workflow": {
      "description": "途中で停止した既存runの再開時も新工程をスキップ可能",
      "implementation": "artifact_refsにstep3_5がない場合は自動スキップ"
    },
    "feature_flags": {
      "enable_step1_5": "default: true, 関連KW抽出を有効化",
      "enable_step3_5": "default: true, 人間味生成を有効化（移行期間後に削除）",
      "enable_step12": "default: true, WordPress HTML生成を有効化",
      "enable_4articles": "default: true, 4記事生成を有効化"
    }
  },

  "tasks": [
    {
      "id": "F-1",
      "type": "workflow",
      "description": "pre_approval.pyの更新 - step1_5を追加",
      "file": "apps/worker/graphs/pre_approval.py",
      "details": {
        "current_flow": "step0 → step1 → step2 → step3_parallel",
        "new_flow": "step0 → step1 → step1_5(optional) → step2 → step3_parallel",
        "changes": [
          "step1_5ノードの追加",
          "step1_5スキップ条件の実装",
          "step2への入力にstep1_5を追加"
        ]
      }
    },
    {
      "id": "F-2",
      "type": "workflow",
      "description": "post_approval.pyの更新 - step3_5, step12を追加",
      "file": "apps/worker/graphs/post_approval.py",
      "details": {
        "current_flow": "step4 → step5 → ... → step10 → step11",
        "new_flow": "step3_5 → step4 → step5 → ... → step10 → step11 → step12",
        "changes": [
          "step3_5を先頭に追加",
          "step12を末尾に追加",
          "step4への入力にstep3_5を追加"
        ]
      }
    },
    {
      "id": "F-3",
      "type": "activity",
      "description": "step2の入力スキーマ更新",
      "file": "apps/worker/activities/step2.py",
      "details": {
        "current_input": "step0, step1",
        "new_input": "step0, step1, step1_5(optional)",
        "changes": [
          "step1_5_outputをオプショナル入力として追加",
          "存在しない場合のハンドリング"
        ]
      }
    },
    {
      "id": "F-4",
      "type": "activity",
      "description": "step4の入力スキーマ更新",
      "file": "apps/worker/activities/step4.py",
      "details": {
        "current_input": "step0, step1, step1.5, step3A, step3B, step3C",
        "new_input": "step0, step1, step1.5, step3A, step3B, step3C, step3_5",
        "changes": [
          "step3_5_outputを必須入力として追加",
          "プロンプトテンプレートの変数追加"
        ]
      }
    },
    {
      "id": "F-5",
      "type": "activity",
      "description": "step7Aの入力スキーマ確認・更新",
      "file": "apps/worker/activities/step7a.py",
      "details": {
        "spec_input": "step0, step3A, step3B, step3C, step3.5, step6, step6.5",
        "changes": [
          "step3_5_outputが入力に含まれていることを確認",
          "必要に応じて追加"
        ]
      }
    },
    {
      "id": "F-6",
      "type": "activity",
      "description": "step11の入力を4記事対応に更新",
      "file": "apps/worker/activities/step11.py",
      "details": {
        "changes": [
          "step10_outputの4記事構造に対応",
          "各記事ごとの画像提案生成"
        ]
      }
    },
    {
      "id": "F-7",
      "type": "temporal",
      "description": "article_workflow.pyの更新",
      "file": "apps/worker/workflows/article_workflow.py",
      "details": {
        "changes": [
          "step1_5 Activityの呼び出し追加",
          "step3_5 Activityの呼び出し追加",
          "step12 Activityの呼び出し追加",
          "artifact_refsの更新"
        ]
      }
    },
    {
      "id": "F-8",
      "type": "spec",
      "description": "workflow.mdの更新",
      "file": "仕様書/workflow.md",
      "details": {
        "changes": [
          "工程一覧テーブルの更新",
          "新工程の追加",
          "依存関係の更新"
        ]
      }
    },
    {
      "id": "F-9",
      "type": "ui",
      "description": "GraphViewTabの工程表示更新",
      "file": "apps/ui/src/components/tabs/GraphViewTab.tsx",
      "details": {
        "changes": [
          "step1_5ノードの追加",
          "step3_5ノードの追加",
          "step12ノードの追加",
          "新しい依存関係の描画"
        ]
      }
    },
    {
      "id": "F-10",
      "type": "api",
      "description": "main.pyのルーター登録更新",
      "file": "apps/api/main.py",
      "details": {
        "changes": [
          "step12ルーターの登録",
          "hearingルーターの登録（Session E完了時）"
        ]
      }
    },
    {
      "id": "F-11",
      "type": "export",
      "description": "activities/__init__.pyの最終更新",
      "file": "apps/worker/activities/__init__.py",
      "details": {
        "exports": [
          "step1_5_related_keyword_extraction",
          "step3_5_human_touch_generation",
          "step12_wordpress_html_generation"
        ],
        "merge_strategy": {
          "approach": "Session F でまとめて追加",
          "reason": "Session A/B/C では __init__.py を編集せず、統合時に一括追加することでマージ競合を回避",
          "implementation": [
            "Session A/B/C: 各stepモジュール内で @activity.defn デコレータを使用",
            "Session F: __init__.py に全新規エクスポートをまとめて追加",
            "条件付きインポート: try/except で未実装モジュールを許容"
          ]
        },
        "conditional_imports": {
          "code_example": "try:\n    from .step1_5 import step1_5_related_keyword_extraction\nexcept ImportError:\n    step1_5_related_keyword_extraction = None  # Optional step"
        }
      }
    },
    {
      "id": "F-12",
      "type": "test",
      "description": "統合テストの作成・更新",
      "file": "tests/integration/test_workflow_migration.py",
      "details": {
        "test_cases": [
          "E2E: 全工程（step0-step12）の通し実行",
          "スキップ: step1_5がない場合のフロー",
          "4記事: step10-12の連携確認",
          "後方互換: 旧形式runの処理"
        ]
      }
    }
  ],

  "verification_checklist": [
    "全工程の順序が正しい: step0 → step1 → step1_5? → step2 → step3_parallel → [承認] → step3_5 → step4 → ... → step12",
    "各工程の入力ファイル数が仕様通り",
    "step1_5がオプショナルとして正しく動作",
    "4記事がstep10からstep12まで正しく流れる",
    "UIでの工程表示が更新されている",
    "既存のrun（旧形式）が壊れない"
  ],

  "rollback_plan": {
    "trigger": "統合テスト失敗",
    "actions": [
      "新工程のActivity登録を無効化",
      "workflow.pyを旧バージョンに戻す",
      "DBマイグレーションのロールバック"
    ]
  }
}
