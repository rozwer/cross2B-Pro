{
  "migration_id": "md-to-json-001",
  "title": "Markdown to JSON Data Exchange Migration",
  "description": "Migration from Markdown-based LLM data exchange to structured JSON format, including prompt management migration from DB to JSON files",
  "created_at": "2025-12-16",
  "status": "completed",
  "source_branch": "origin/claude/migrate-md-to-json-Kvl5R",
  "changes": {
    "backend": {
      "activities": {
        "step6_5": {
          "file": "apps/worker/activities/step6_5.py",
          "changes": [
            "Added JSON parsing for LLM response",
            "Extract fields: integration_package, outline_summary, section_count, total_sources",
            "Raise ActivityError on JSON parse failure (RETRYABLE)"
          ]
        },
        "step7a": {
          "file": "apps/worker/activities/step7a.py",
          "changes": [
            "Added JSON parsing for LLM response",
            "Extract fields: draft, word_count, section_count, cta_positions",
            "Raise ActivityError on JSON parse failure (RETRYABLE)"
          ]
        },
        "step7b": {
          "file": "apps/worker/activities/step7b.py",
          "changes": [
            "Added JSON parsing for LLM response",
            "Extract fields: polished, word_count, changes_made",
            "Raise ActivityError on JSON parse failure (RETRYABLE)"
          ]
        },
        "step9": {
          "file": "apps/worker/activities/step9.py",
          "changes": [
            "Added JSON parsing for LLM response",
            "Extract fields: final_content, word_count, meta_description, internal_link_suggestions",
            "Raise ActivityError on JSON parse failure (RETRYABLE)"
          ]
        }
      },
      "graphs": {
        "pre_approval": {
          "file": "apps/worker/graphs/pre_approval.py",
          "changes": [
            "Added import json",
            "Added JSON parsing with fallback for step0, step3a, step3b, step3c",
            "Fallback stores raw content in raw_content field if JSON parse fails"
          ]
        },
        "post_approval": {
          "file": "apps/worker/graphs/post_approval.py",
          "changes": [
            "Added import json",
            "Added JSON parsing with fallback for step4, step6",
            "Added JSON parsing with field extraction for step6_5, step7a, step7b, step9",
            "Fallback stores raw content in respective content fields if JSON parse fails"
          ]
        }
      }
    },
    "frontend": {
      "ArtifactViewer": {
        "file": "apps/ui/src/components/artifacts/ArtifactViewer.tsx",
        "changes": [
          "Added MARKDOWN_FIELDS constant for detecting Markdown content in JSON",
          "Added view mode toggle (json/markdown) in ContentRenderer",
          "Auto-detects Markdown fields: draft, polished, final_content, integration_package, markdown, content",
          "Shows toggle UI when Markdown content > 100 characters detected"
        ]
      }
    }
  },
  "json_schema": {
    "step6_5": {
      "integration_package": "string (Markdown format)",
      "outline_summary": "string",
      "section_count": "number",
      "total_sources": "number"
    },
    "step7a": {
      "draft": "string (Markdown format)",
      "word_count": "number",
      "section_count": "number",
      "cta_positions": "array"
    },
    "step7b": {
      "polished": "string (Markdown format)",
      "word_count": "number",
      "changes_made": "array"
    },
    "step9": {
      "final_content": "string (Markdown format)",
      "word_count": "number",
      "meta_description": "string",
      "internal_link_suggestions": "array"
    }
  },
  "prompt_management": {
    "loader": {
      "file": "apps/api/prompts/loader.py",
      "changes": [
        "Migrated from DB-based loading to JSON file-based loading",
        "Removed SQLAlchemy dependencies",
        "Added _load_from_json() method for JSON file parsing",
        "Added list_packs() method to list available pack files",
        "Updated mock_pack with correct step names (step0, step3a, etc.)"
      ]
    },
    "packs_directory": "apps/api/prompts/packs/",
    "default_pack": {
      "file": "apps/api/prompts/packs/default.json",
      "steps": ["step0", "step1", "step2", "step3a", "step3b", "step3c", "step4", "step5", "step6", "step6_5", "step7a", "step7b", "step8", "step9", "step10"],
      "all_prompts_include_json_output_instructions": true
    }
  },
  "notes": [
    "Prompt templates are now stored in JSON files under apps/api/prompts/packs/",
    "Each pack is a single JSON file with all step prompts",
    "Activities use strict JSON parsing (raise error on failure)",
    "Graph nodes use lenient JSON parsing (fallback to raw_content on failure)",
    "Frontend auto-detects Markdown fields in JSON and offers view mode toggle"
  ],
  "rollback_instructions": [
    "Revert changes in activities to remove JSON parsing",
    "Revert changes in graphs to remove JSON parsing",
    "Revert ArtifactViewer changes to remove view mode toggle",
    "Update prompt templates to request Markdown output"
  ]
}
