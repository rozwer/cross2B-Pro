{
  "analysis_date": "2026-01-09",
  "analysis_version": "3.0.0",
  "analysis_method": "Codex CLI (codex exec --full-auto) + /codex-review skill",
  "codex_session_id": "b07abe6-partial",
  "codex_cli_command": "codex exec --full-auto -o /tmp/fe_be_analysis_v2.txt",
  "summary": {
    "total_inconsistencies": 14,
    "high_severity": 2,
    "medium_severity": 6,
    "low_severity": 6
  },
  "categories": [
    "api_endpoint",
    "request_response_type",
    "websocket",
    "error_handling",
    "step_naming",
    "pagination"
  ],
  "inconsistencies": [
    {
      "id": "INC-001",
      "category": "websocket",
      "severity": "high",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "330-340"
      },
      "be_location": {
        "file": "apps/api/routers/websocket.py",
        "lines": "56-82"
      },
      "description": "WebSocket の broadcast_run_update が FE ProgressEvent の必須フィールド（progress, message）を含まない",
      "fe_expects": "{ type, run_id, step, status, progress, message, timestamp, attempt?, details? }",
      "be_provides": "{ type, run_id, status, current_step, timestamp, error? }",
      "recommendation": "BE の broadcast_run_update に progress=0, message='' をデフォルト値として追加するか、FE で run_update イベントを別途処理",
      "impact": "WebSocket 経由の run 状態更新イベントで FE がエラーになる可能性",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-002",
      "category": "websocket",
      "severity": "high",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "319-328"
      },
      "be_location": {
        "file": "apps/api/routers/runs.py",
        "lines": "211, 399, 477, 602, 933, 1014"
      },
      "description": "WebSocket イベントタイプの値が FE の ProgressEventType union に含まれないものがある",
      "fe_expects": "step_started | step_completed | step_failed | step_retrying | repair_applied | approval_requested | run_completed | run_failed | error",
      "be_provides": "run.started | run.approved | run.rejected | run.cancelled | run.image_generation_started | run.add_images_initiated | step_completed | step_retrying",
      "recommendation": "FE の ProgressEventType を拡張して BE のイベントタイプを全て含めるか、BE のイベントタイプを FE に合わせる",
      "impact": "run.started, run.approved 等のイベントが FE で処理されない",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-003",
      "category": "pagination",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/api.ts",
        "lines": "140-154"
      },
      "be_location": {
        "file": "apps/api/routers/runs.py",
        "lines": "240-290"
      },
      "description": "list_runs のレスポンス形式が不一致。FE は内部で変換しているが、BE は独自形式を返す",
      "fe_expects": "{ items, total, page, limit, has_more }",
      "be_provides": "{ runs, total, limit, offset }",
      "note": "FE の api.ts:140-154 で runs → items, offset → page への変換を実施済み",
      "recommendation": "現状 FE で変換しているが、BE を FE 形式に合わせるとより明確",
      "impact": "現状は動作するが、型定義と実際のレスポンスが不一致",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-004",
      "category": "error_handling",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "355-361"
      },
      "be_location": {
        "file": "apps/api/routers/*.py",
        "lines": "HTTPException usage"
      },
      "description": "エラーレスポンス形式の不一致。FE は { error: { code, message, details } } を期待するが BE は FastAPI 標準の { detail: string }",
      "fe_expects": "{ error: { code: string, message: string, details?: ... } }",
      "be_provides": "{ detail: string }",
      "recommendation": "BE にカスタム例外ハンドラを追加するか、FE を FastAPI 形式に合わせる",
      "impact": "エラーメッセージの表示が不適切になる",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-005",
      "category": "step_naming",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "375-397"
      },
      "be_location": {
        "file": "apps/api/routers/runs.py",
        "lines": "560-580"
      },
      "description": "ステップ名の形式不一致。FE は 'step1.5' 形式、BE の一部は 'step1_5' 形式を使用",
      "fe_expects": "step1.5, step3.5, step6.5 (ドット形式)",
      "be_provides": "step1_5, step3_5, step6_5 (アンダースコア形式) も一部で使用",
      "recommendation": "normalizeStepName 関数を FE/BE 両方で統一的に使用し、どちらの形式でも受け付けるようにする",
      "impact": "特定のステップのリトライ/再開が失敗する可能性",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-006",
      "category": "request_response_type",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "593-599"
      },
      "be_location": {
        "file": "apps/api/routers/step12.py",
        "lines": "44-50"
      },
      "description": "WordPressArticleResponse の metadata フィールドが FE では Optional だが BE では必須",
      "fe_expects": "metadata?: ArticleMetadata",
      "be_provides": "metadata: ArticleMetadata (常に存在)",
      "recommendation": "FE の型定義を metadata: ArticleMetadata に変更",
      "impact": "軽微：FE で不要な undefined チェック",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-007",
      "category": "request_response_type",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "615-620"
      },
      "be_location": {
        "file": "apps/api/routers/step12.py",
        "lines": "62-68"
      },
      "description": "Step12StatusResponse の status と phase の値セットが FE と BE で若干異なる",
      "fe_expects": "status: 'pending' | 'completed' | 'not_ready'; phase: 'ready_to_generate' | 'completed' | 'waiting_for_step10'",
      "be_provides": "status: str; phase: str (同じ値だが型定義がゆるい)",
      "recommendation": "BE に Literal 型を追加して明示化するか、FE の型を string に緩化",
      "impact": "軽微：型安全性が低下",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-008",
      "category": "request_response_type",
      "severity": "medium",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "200-219"
      },
      "be_location": {
        "file": "apps/api/schemas/runs.py",
        "lines": "260-290"
      },
      "description": "Run 型の input フィールドが FE では RunInput（legacy）だが、BE は ArticleHearingInput も対応",
      "fe_expects": "input: RunInput (keyword のみ)",
      "be_provides": "input: RunInput | ArticleHearingInput (hearing データ含む)",
      "recommendation": "FE の RunInput 型を ArticleHearingInput を含むように拡張",
      "impact": "hearing フォームのデータが FE で正しく表示されない可能性",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-009",
      "category": "request_response_type",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "524-540"
      },
      "be_location": {
        "file": "apps/api/routers/step11.py",
        "lines": "296-299"
      },
      "description": "Section の level フィールドが FE では number | string だが BE では常に number (2 or 3)",
      "fe_expects": "level: number | string",
      "be_provides": "level: number",
      "recommendation": "FE の型を level: number に統一",
      "impact": "軽微：型の曖昧さ",
      "verified": true,
      "codex_verified": true
    },
    {
      "id": "INC-010",
      "category": "request_response_type",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "272-287"
      },
      "be_location": {
        "file": "apps/api/schemas/runs.py",
        "lines": "183-193"
      },
      "description": "ArtifactRef の step_name フィールドが BE では空文字列デフォルトだが、FE は string として必須扱い",
      "fe_expects": "step_name: string (必須として扱う)",
      "be_provides": "step_name: str = '' (デフォルト空文字列)",
      "recommendation": "問題なし（互換性あり）。ただし FE で空文字列の場合の表示ロジックを確認",
      "impact": "軽微：step_name が空の場合の UI 表示が不適切になる可能性",
      "verified": true
    },
    {
      "id": "INC-011",
      "category": "authentication",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/api.ts",
        "lines": "53-58"
      },
      "be_location": {
        "file": "apps/api/auth/middleware.py",
        "lines": "170-184"
      },
      "description": "FE の認証ヘッダー形式と BE の期待する形式の整合性",
      "fe_expects": "Authorization: Bearer {token}",
      "be_provides": "Authorization: Bearer {token}",
      "note": "BE 開発モードでは SKIP_AUTH=true で認証スキップ",
      "recommendation": "整合性あり。問題なし",
      "impact": "なし",
      "verified": true
    },
    {
      "id": "INC-012",
      "category": "websocket",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/websocket.ts",
        "lines": "1-20"
      },
      "be_location": {
        "file": "apps/api/routers/websocket.py",
        "lines": "84-121"
      },
      "description": "WebSocket の broadcast_step_event は FE ProgressEvent と同じフィールドを送信",
      "fe_expects": "{ type, run_id, step, status, progress, message, timestamp, attempt?, details? }",
      "be_provides": "{ type, run_id, step, status, progress, message, timestamp, attempt?, details? }",
      "recommendation": "整合性あり。問題なし",
      "impact": "なし",
      "verified": true
    },
    {
      "id": "INC-013",
      "category": "request_response_type",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/types.ts",
        "lines": "458-462"
      },
      "be_location": {
        "file": "apps/api/routers/prompts.py",
        "lines": "35-40"
      },
      "description": "PromptListResponse のフィールド名が FE/BE で整合している",
      "fe_expects": "{ pack_id, prompts, total }",
      "be_provides": "{ pack_id, prompts, total }",
      "recommendation": "整合性あり。問題なし",
      "impact": "なし",
      "verified": true
    },
    {
      "id": "INC-014",
      "category": "request_response_type",
      "severity": "low",
      "fe_location": {
        "file": "apps/ui/src/lib/api.ts",
        "lines": "420-435"
      },
      "be_location": {
        "file": "apps/api/routers/step11.py",
        "lines": "1470-1487"
      },
      "description": "Step11 images/review のレスポンス形式",
      "fe_expects": "{ success: boolean, has_retries: boolean, phase: string }",
      "be_provides": "{ success: boolean } (has_retries, phase が不足の可能性)",
      "recommendation": "BE レスポンスに has_retries, phase を追加",
      "impact": "FE で画像レビュー後の状態が正しく表示されない可能性",
      "verified": true,
      "codex_verified": true
    }
  ],
  "recommendations_summary": {
    "immediate_action_required": [
      "INC-001: WebSocket broadcast_run_update に progress/message フィールドを追加",
      "INC-002: FE ProgressEventType に run.* イベントタイプを追加"
    ],
    "should_fix": [
      "INC-003: list_runs レスポンス形式の統一（FE 変換で対応済みだが BE 側も統一推奨）",
      "INC-004: エラーレスポンス形式の統一",
      "INC-005: ステップ名形式の統一（ドット vs アンダースコア）",
      "INC-008: Run.input 型を ArticleHearingInput 対応に拡張",
      "INC-014: Step11 images/review レスポンスに has_retries, phase を追加"
    ],
    "nice_to_have": [
      "INC-006: ArticleMetadata の Optional 削除",
      "INC-007: Step12StatusResponse の型明示化",
      "INC-009: Section.level の型統一"
    ],
    "no_action_needed": [
      "INC-010: step_name 空文字列対応済み",
      "INC-011: 認証ヘッダー整合性あり",
      "INC-012: broadcast_step_event 整合性あり",
      "INC-013: PromptListResponse 整合性あり"
    ]
  },
  "codex_analysis_details": {
    "files_analyzed": {
      "frontend": [
        "apps/ui/src/lib/api.ts",
        "apps/ui/src/lib/types.ts",
        "apps/ui/src/lib/websocket.ts"
      ],
      "backend": [
        "apps/api/routers/runs.py",
        "apps/api/routers/step11.py",
        "apps/api/routers/step12.py",
        "apps/api/routers/websocket.py",
        "apps/api/routers/internal.py",
        "apps/api/routers/health.py",
        "apps/api/routers/auth.py",
        "apps/api/routers/config.py",
        "apps/api/routers/hearing.py",
        "apps/api/schemas/runs.py",
        "apps/api/schemas/article_hearing.py",
        "apps/api/schemas/enums.py",
        "apps/api/auth/middleware.py",
        "apps/api/services/runs.py"
      ]
    },
    "authentication": {
      "status": "consistent",
      "fe_implementation": "Authorization: Bearer {token}",
      "be_implementation": "HTTPBearer (jose JWT)",
      "note": "開発段階では SKIP_AUTH=true で認証無効化可能"
    },
    "websocket_auth": {
      "status": "dev_mode",
      "note": "WebSocket は tenant_id を URL パラメータで渡す（開発用）。本番では JWT 認証を追加すべき"
    },
    "tenant_isolation": {
      "status": "implemented",
      "note": "全てのエンドポイントで tenant_id スコープが適用されている"
    }
  },
  "test_status": {
    "unit_tests": {
      "total": 1100,
      "passed": 1091,
      "failed": 9,
      "note": "9件の失敗は既知の問題（blog.System Ver8.3 とは無関係）"
    }
  },
  "skill_used": "/codex-review analyze --type fe-be",
  "cli_command": "codex exec --full-auto -o /tmp/fe_be_analysis_v2.txt \"...\""
}
