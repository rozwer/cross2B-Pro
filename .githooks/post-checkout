#!/bin/bash
# post-checkout hook: 依存関係の変更を通知

# 引数
PREV_HEAD="$1"
NEW_HEAD="$2"
BRANCH_CHECKOUT="$3"  # 1=ブランチ切替, 0=ファイルチェックアウト

# ファイルチェックアウトの場合はスキップ
if [ "$BRANCH_CHECKOUT" = "0" ]; then
    exit 0
fi

# 色定義
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# 変更されたファイルをチェック
CHANGED_FILES=$(git diff --name-only "$PREV_HEAD" "$NEW_HEAD" 2>/dev/null)

if [ -z "$CHANGED_FILES" ]; then
    exit 0
fi

echo ""

# ===========================================
# Python 依存関係チェック
# ===========================================
if echo "$CHANGED_FILES" | grep -q "pyproject.toml\|uv.lock"; then
    echo -e "${YELLOW}📦 Python 依存関係が変更されています${NC}"
    echo -e "${CYAN}   → uv sync を実行してください${NC}"
    echo ""
fi

# ===========================================
# Node.js 依存関係チェック
# ===========================================
if echo "$CHANGED_FILES" | grep -q "package.json\|package-lock.json\|bun.lockb"; then
    echo -e "${YELLOW}📦 Node.js 依存関係が変更されています${NC}"

    if echo "$CHANGED_FILES" | grep -q "apps/ui/package"; then
        echo -e "${CYAN}   → cd apps/ui && npm install${NC}"
    else
        echo -e "${CYAN}   → npm install を実行してください${NC}"
    fi
    echo ""
fi

# ===========================================
# .env.example チェック
# ===========================================
if echo "$CHANGED_FILES" | grep -q ".env.example"; then
    echo -e "${YELLOW}⚙️  .env.example が更新されています${NC}"
    echo -e "${CYAN}   → .env との差分を確認してください${NC}"

    if [ -f ".env" ] && [ -f ".env.example" ]; then
        # .env.example にあって .env にない変数を検出
        MISSING_VARS=$(comm -23 <(grep -E '^[A-Z_]+=' .env.example | cut -d= -f1 | sort) <(grep -E '^[A-Z_]+=' .env | cut -d= -f1 | sort) 2>/dev/null)
        if [ -n "$MISSING_VARS" ]; then
            echo -e "${YELLOW}   不足している変数:${NC}"
            echo "$MISSING_VARS" | while read var; do
                echo "     - $var"
            done
        fi
    fi
    echo ""
fi

# ===========================================
# データベースマイグレーション
# ===========================================
if echo "$CHANGED_FILES" | grep -q "migrations/\|alembic/"; then
    echo -e "${YELLOW}🗃️  データベースマイグレーションが追加されています${NC}"

    # 新しいマイグレーションファイルを表示
    NEW_MIGRATIONS=$(echo "$CHANGED_FILES" | grep -E "migrations/.*\.py$|alembic/versions/.*\.py$" || true)
    if [ -n "$NEW_MIGRATIONS" ]; then
        echo -e "${CYAN}   新しいマイグレーション:${NC}"
        echo "$NEW_MIGRATIONS" | while read migration; do
            echo "     - $migration"
        done
    fi

    echo ""
    echo -e "${CYAN}   実行コマンド:${NC}"
    echo "     alembic upgrade head"
    echo ""
    echo -e "${YELLOW}   ⚠️  本番環境では事前にバックアップを取得してください${NC}"
    echo ""
fi

# ===========================================
# Docker 設定
# ===========================================
if echo "$CHANGED_FILES" | grep -q "docker-compose\|Dockerfile"; then
    echo -e "${YELLOW}🐳 Docker 設定が変更されています${NC}"
    echo -e "${CYAN}   → docker compose up --build を検討してください${NC}"
    echo ""
fi

exit 0
