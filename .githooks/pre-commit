#!/bin/bash
# pre-commit hook: コード品質チェック

set -e

# 色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "🔍 pre-commit チェックを実行中..."
echo ""

# ステージされたファイルを取得
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "ステージされたファイルがありません"
    exit 0
fi

# エラーフラグ
HAS_ERROR=0

# ===========================================
# 1. 秘密情報検出
# ===========================================
echo "🔐 秘密情報をチェック中..."

SECRET_PATTERNS=(
    'OPENAI_API_KEY\s*=\s*["\x27]?sk-[a-zA-Z0-9]+'
    'ANTHROPIC_API_KEY\s*=\s*["\x27]?sk-ant-[a-zA-Z0-9]+'
    'GEMINI_API_KEY\s*=\s*["\x27]?[a-zA-Z0-9_-]{39}'
    'AWS_SECRET_ACCESS_KEY\s*=\s*["\x27]?[A-Za-z0-9/+=]{40}'
    'password\s*=\s*["\x27][^"\x27]{8,}["\x27]'
    'api_key\s*=\s*["\x27][a-zA-Z0-9_-]{20,}["\x27]'
)

# 秘密情報検出を除外するファイルパターン
EXCLUDE_SECRET_CHECK=(
    "*.md"                    # Markdown ドキュメント（サンプルコード含む）
    ".claude/*"               # Claude Code 設定（サンプルパターン含む）
    ".claude-making/*"        # テンプレートディレクトリ
    "*.example"               # サンプル設定ファイル
    "tests/*"                 # テストファイル
)

# ダミー値パターン（除外）
DUMMY_PATTERNS=(
    "sk-xxxx"
    "sk-xxx"
    "YOUR_"
    "your-"
    "example"
    "dummy"
    "test"
    "placeholder"
)

should_check_secrets() {
    local file="$1"
    for pattern in "${EXCLUDE_SECRET_CHECK[@]}"; do
        if [[ "$file" == $pattern ]]; then
            return 1  # 除外
        fi
    done
    return 0  # チェック対象
}

is_dummy_value() {
    local file="$1"
    local content
    content=$(cat "$file" 2>/dev/null || echo "")
    for dummy in "${DUMMY_PATTERNS[@]}"; do
        if echo "$content" | grep -qi "$dummy"; then
            return 0  # ダミー値を含む
        fi
    done
    return 1
}

for file in $STAGED_FILES; do
    if [[ ! -f "$file" ]]; then
        continue
    fi
    # .env ファイルはスキップ（ただし .env.example は除く）
    if [[ "$file" == ".env" ]] || [[ "$file" == *".env.local"* ]] || [[ "$file" == *".env.production"* ]]; then
        echo -e "${RED}⚠️  .env ファイルがステージされています: $file${NC}"
        echo "   .gitignore に追加してください"
        HAS_ERROR=1
        continue
    fi

    # 除外パターンに該当する場合はスキップ
    if ! should_check_secrets "$file"; then
        continue
    fi

    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -Eq "$pattern" "$file" 2>/dev/null; then
            # ダミー値を含む場合はスキップ
            matched_line=$(grep -E "$pattern" "$file" 2>/dev/null | head -1)
            is_dummy=0
            for dummy in "${DUMMY_PATTERNS[@]}"; do
                if echo "$matched_line" | grep -qi "$dummy"; then
                    is_dummy=1
                    break
                fi
            done
            if [ $is_dummy -eq 0 ]; then
                echo -e "${RED}⚠️  秘密情報の可能性: $file${NC}"
                echo "   パターン: $pattern"
                HAS_ERROR=1
            fi
        fi
    done
done

if [ $HAS_ERROR -eq 0 ]; then
    echo -e "${GREEN}✓ 秘密情報なし${NC}"
fi

# ===========================================
# 2. Python ファイルのチェック
# ===========================================
PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    echo ""
    echo "🐍 Python コードをチェック中..."

    # ruff lint
    if command -v ruff &> /dev/null; then
        echo "  ruff check..."
        if ! ruff check $PYTHON_FILES --fix --exit-non-zero-on-fix; then
            echo -e "${RED}⚠️  ruff で問題が見つかりました${NC}"
            HAS_ERROR=1
        else
            echo -e "${GREEN}  ✓ ruff check passed${NC}"
        fi

        # ruff format
        echo "  ruff format..."
        if ! ruff format $PYTHON_FILES --check; then
            echo -e "${YELLOW}  自動フォーマット中...${NC}"
            ruff format $PYTHON_FILES
            git add $PYTHON_FILES
            echo -e "${GREEN}  ✓ フォーマット完了（自動ステージ）${NC}"
        else
            echo -e "${GREEN}  ✓ ruff format passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ruff が見つかりません（スキップ）${NC}"
    fi

    # mypy 型チェック
    if command -v mypy &> /dev/null; then
        echo "  mypy..."
        if ! mypy $PYTHON_FILES --ignore-missing-imports --no-error-summary 2>/dev/null; then
            echo -e "${YELLOW}⚠️  mypy で型エラーがあります（警告のみ）${NC}"
            # 型エラーは警告のみ（ブロックしない）
        else
            echo -e "${GREEN}  ✓ mypy passed${NC}"
        fi
    fi
fi

# ===========================================
# 3. TypeScript/JavaScript ファイルのチェック
# ===========================================
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_FILES" ]; then
    echo ""
    echo "📘 TypeScript/JavaScript コードをチェック中..."

    # oxlint (bunx oxlint)
    if command -v bunx &> /dev/null; then
        echo "  oxlint..."
        if ! bunx oxlint $TS_FILES 2>/dev/null; then
            echo -e "${RED}⚠️  oxlint で問題が見つかりました${NC}"
            HAS_ERROR=1
        else
            echo -e "${GREEN}  ✓ oxlint passed${NC}"
        fi

        # oxfmt (bunx oxfmt) - 自動フォーマット
        echo "  oxfmt..."
        # oxfmt はまだ実験的なので、失敗してもブロックしない
        if bunx oxc_formatter --write $TS_FILES 2>/dev/null; then
            # フォーマットされたファイルを再ステージ
            git add $TS_FILES
            echo -e "${GREEN}  ✓ oxfmt 完了（自動ステージ）${NC}"
        else
            echo -e "${YELLOW}  oxfmt スキップ（未対応）${NC}"
        fi
    else
        echo -e "${YELLOW}  bunx が見つかりません（スキップ）${NC}"
    fi

    # TypeScript 型チェック（apps/ui 配下のみ）
    UI_TS_FILES=$(echo "$TS_FILES" | grep '^apps/ui/' || true)
    if [ -n "$UI_TS_FILES" ] && [ -f "apps/ui/tsconfig.json" ]; then
        echo "  tsc --noEmit..."
        if (cd apps/ui && npx tsc --noEmit 2>/dev/null); then
            echo -e "${GREEN}  ✓ TypeScript check passed${NC}"
        else
            echo -e "${YELLOW}⚠️  TypeScript で型エラーがあります（警告のみ）${NC}"
        fi
    fi
fi

# ===========================================
# 4. JSON/YAML ファイルの検証
# ===========================================
JSON_FILES=$(echo "$STAGED_FILES" | grep -E '\.json$' || true)
YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ya?ml)$' || true)

if [ -n "$JSON_FILES" ]; then
    echo ""
    echo "📄 JSON ファイルを検証中..."
    for file in $JSON_FILES; do
        if [[ -f "$file" ]]; then
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo -e "${RED}⚠️  JSON 構文エラー: $file${NC}"
                HAS_ERROR=1
            fi
        fi
    done
    if [ $HAS_ERROR -eq 0 ]; then
        echo -e "${GREEN}✓ JSON 検証完了${NC}"
    fi
fi

if [ -n "$YAML_FILES" ]; then
    echo ""
    echo "📄 YAML ファイルを検証中..."
    if command -v python3 &> /dev/null; then
        for file in $YAML_FILES; do
            if [[ -f "$file" ]]; then
                if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                    echo -e "${RED}⚠️  YAML 構文エラー: $file${NC}"
                    HAS_ERROR=1
                fi
            fi
        done
        if [ $HAS_ERROR -eq 0 ]; then
            echo -e "${GREEN}✓ YAML 検証完了${NC}"
        fi
    fi
fi

# ===========================================
# 結果
# ===========================================
echo ""
if [ $HAS_ERROR -ne 0 ]; then
    echo -e "${RED}❌ pre-commit チェック失敗${NC}"
    echo ""
    echo "修正後、再度コミットしてください。"
    echo "緊急時: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}✅ pre-commit チェック完了${NC}"
exit 0
